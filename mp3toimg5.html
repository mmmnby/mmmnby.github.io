<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Spectrogram Player with Phase 1 Fast Fill & Phase 2 Overlay</title>
<style>
  body { background:#111; color:#fff; font-family:sans-serif; margin:0; text-align:center; }
  .controls { padding:10px; }
  .controls>* { margin:4px; font-size:16px; }
  #timeDisplay { margin-top:6px; font-size:14px; font-style:italic; }
  .canvas-container { position:relative; display:inline-block; margin-bottom:20px; }
  canvas.spectro { background:#000; display:block; }
  canvas.overlay { position:absolute; left:0; top:0; pointer-events:auto; }
  #navButtons { margin:10px; display:none; }
  #navButtons button { margin:0 6px; font-size:16px; padding:6px 12px; }
</style>
</head>
<body>
<h1>Spectrogram Player with Phase 1 Fast Fill & Phase 2 Playback</h1>

<div class="controls">
  <input type="file" id="audioFile" accept=".mp3" />
  <label>Speed:
    <select id="speed"><option>1</option><option>2</option><option>4</option><option>30</option><option>60</option><option>120</option></select>×
  </label>
  <button id="startBtn">Start Phase 1</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="saveBtn">Download PNG</button>
  <div id="timeDisplay">No file loaded.</div>
</div>
<div id="rowsContainer"></div>
<div id="navButtons">
  <button id="back15">◀ 15s</button>
  <button id="masterToggle">Play</button>
  <button id="forward15">15s ▶</button>
</div>

<script>
const CANVAS_W = window.innerWidth, CANVAS_H = 300;
const TICK_H=10, LABEL_H=20;
const USABLE_H = CANVAS_H - TICK_H - LABEL_H;
const LABEL_INT=100, PAD=6;
const fileInput=document.getElementById('audioFile'),
 speedSel=document.getElementById('speed'),
 startBtn=document.getElementById('startBtn'),
 pauseBtn=document.getElementById('pauseBtn'),
 saveBtn=document.getElementById('saveBtn'),
 timeDisplay=document.getElementById('timeDisplay'),
 rowsContainer=document.getElementById('rowsContainer'),
 navButtons=document.getElementById('navButtons'),
 back15=document.getElementById('back15'),
 masterToggle=document.getElementById('masterToggle'),
 forward15=document.getElementById('forward15');

let audio, audioCtx, analyser, dataArr;
let drawX=0, isPaused=false;
let rowCanvas=[], overlayCanvas=[], rowT=new Float32Array(0);
let phase2Audio=null, phase2Playing=false;

function fmtT(s){ const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=Math.floor(s%60); return `${h}h${m}m${sec}s`; }
function updDisp(cur,dur){ timeDisplay.textContent = `Time: ${fmtT(cur)} / ${fmtT(dur)}`; }

function newRow(t){
  const row=document.createElement('div'); row.className='canvas-container';
  const sc=document.createElement('canvas'); sc.width=CANVAS_W; sc.height=CANVAS_H; sc.className='spectro';
  const sctx=sc.getContext('2d'); sctx.fillStyle='#000'; sctx.fillRect(0,0,CANVAS_W,CANVAS_H);
  row.appendChild(sc);
  const ov=document.createElement('canvas'); ov.width=CANVAS_W; ov.height=CANVAS_H; ov.className='overlay';
  row.appendChild(ov);
  rowsContainer.appendChild(row);
  rowCanvas.push(sc.getContext('2d'));
  overlayCanvas.push(ov.getContext('2d'));
  rowT = Float32Array.from([...rowT, t]);
  drawX=0;
}

function phase1Loop(){
  if(!audio||audio.paused||audio.ended||isPaused) return;
  analyser.getByteFrequencyData(dataArr);
  if(!rowCanvas.length) newRow(audio.currentTime);
  let ctx=rowCanvas[rowCanvas.length-1];
  if(drawX>=CANVAS_W) { newRow(audio.currentTime); ctx=rowCanvas[rowCanvas.length-1]; }
  for(let y=0;y<analyser.frequencyBinCount;y++){
    const v=dataArr[y];
    ctx.fillStyle=`hsl(${v*1.5},100%,50%)`;
    ctx.fillRect(drawX,USABLE_H-y,1,1);
  }
  let el=Math.floor(audio.currentTime);
  if(el%60==0){ ctx.strokeStyle='#fff'; ctx.lineWidth=el%900?1:2;
    ctx.beginPath(); ctx.moveTo(drawX+.5,USABLE_H); ctx.lineTo(drawX+.5,USABLE_H+TICK_H); ctx.stroke(); }
  if(drawX%LABEL_INT==0){
    const L=fmtT(audio.currentTime), w=ctx.measureText(L).width;
    ctx.fillStyle='#000'; ctx.fillRect(drawX-w/2-PAD,USABLE_H+TICK_H,w+2*PAD,LABEL_H);
    ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.font='12px sans-serif';
    ctx.fillText(L,drawX,USABLE_H+TICK_H+2);
  }
  drawX++;
  updDisp(audio.currentTime,audio.duration||0);
  requestAnimationFrame(phase1Loop);
}

function fastFill(){
  let ctx=rowCanvas[rowCanvas.length-1];
  const startX=drawX;
  const missing = CANVAS_W - startX;
  if(missing<=0) return finishPhase1();
  const speed=4;
  const checker=6;
  for(let x=startX;x<CANVAS_W;x+=1){
    const col = (Math.floor(x/checker)^Math.floor((USABLE_H)/checker))%2? '#222':'#444';
    ctx.fillStyle=col;
    ctx.fillRect(x,0,1,CANVAS_H);
  }
  // Extrapolate end-time for this row
  const t0=rowT[rowT.length-1];
  const elapsed=audio.duration;
  const extDur=audio.duration - t0;
  rowT[rowT.length-1] = t0;
  rowT = Float32Array.from([...rowT, audio.duration + extDur]);
  finishPhase1();
}

function finishPhase1(){
  audio.pause();
  setupPhase2();
}

function startPhase1(){
  if(!fileInput.files[0]) return alert('Select MP3!');
  if(audio) audio.pause();
  rowsContainer.innerHTML=''; rowCanvas=[]; overlayCanvas=[]; rowT=new Float32Array(0);
  navButtons.style.display='none';
  audio = new Audio(URL.createObjectURL(fileInput.files[0]));
  audio.crossOrigin='anonymous'; audio.preload='auto'; audio.playbackRate=+speedSel.value;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  analyser=audioCtx.createAnalyser(); analyser.fftSize=512;
  const src=audioCtx.createMediaElementSource(audio); src.connect(analyser); analyser.connect(audioCtx.destination);
  dataArr = new Uint8Array(analyser.frequencyBinCount);
  drawX=0; isPaused=false;
  startBtn.disabled=true; pauseBtn.disabled=false;
  audio.play();
  phase1Loop();
  audio.onended = fastFill;
}

function setupPhase2(){
  new Audio(); phase2Audio?.pause();
  phase2Audio=new Audio(URL.createObjectURL(fileInput.files[0]));
  phase2Audio.crossOrigin='anonymous'; phase2Audio.preload='auto'; phase2Audio.playbackRate=1;
  phase2Playing=false; navButtons.style.display='block';
  overlayCanvas.forEach((ctxOv,i)=>{
    const canOv=ctxOv.canvas;
    canOv.style.pointerEvents='auto';
    canOv.onclick=(e)=>{
      const x=e.offsetX, t0=rowT[i], t1=rowT[i+1]||phase2Audio.duration;
      phase2Audio.currentTime = t0 + (x/CANVAS_W)*(t1-t0);
      phase2Audio.play();
      drawPhase2Cursor();
    };
  });
  phase2Audio.onplay = ()=>{phase2Playing=true; masterToggle.textContent='Pause';};
  phase2Audio.onpause = ()=>{phase2Playing=false; masterToggle.textContent='Play';};
  phase2Audio.ontimeupdate = ()=>{ updDisp(phase2Audio.currentTime,phase2Audio.duration); };
  phase2Audio.onended = ()=>{ phase2Playing=false; masterToggle.textContent='Play'; };
}

function drawPhase2Cursor(){
  if(!phase2Audio) return;
  overlayCanvas.forEach((ctxOv,i)=>{
    ctxOv.clearRect(0,0,CANVAS_W,CANVAS_H);
    const t=phase2Audio.currentTime, t0=rowT[i], t1=rowT[i+1]||phase2Audio.duration;
    if(t<t0||t>t1) return;
    const x=(t-t0)/(t1-t0)*CANVAS_W;
    [5,'red'],[3,'white'],[1,'black'].forEach(([w,clr])=>{
      ctxOv.lineWidth=w; ctxOv.strokeStyle=clr;
      ctxOv.beginPath(); ctxOv.moveTo(x+.5,0); ctxOv.lineTo(x+.5,CANVAS_H); ctxOv.stroke();
    });
  });
}

startBtn.onclick=startPhase1;
pauseBtn.onclick=()=>{
  isPaused ? audio.play() : audio.pause();
  isPaused=!isPaused;
};
back15.onclick=()=>phase2Audio && (phase2Audio.currentTime=Math.max(0,phase2Audio.currentTime-15));
forward15.onclick=()=>phase2Audio && (phase2Audio.currentTime=Math.min(phase2Audio.duration,phase2Audio.currentTime+15));
masterToggle.onclick=()=>phase2Playing ? phase2Audio.pause() : phase2Audio.play();
saveBtn.onclick=()=>alert('PNG save not implemented');
fileInput.onchange=()=>{const t=new Audio(URL.createObjectURL(fileInput.files[0]));t.onloadedmetadata=()=>updDisp(0,t.duration);};
</script>
</body>
</html>
