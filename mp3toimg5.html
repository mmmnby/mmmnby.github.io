<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Spectrogram Player (Fixed Overlay Width)</title>
<style>
  body { background:#111; color:#fff; font-family:sans-serif; margin:0; text-align:center; }
  .controls { padding:10px; }
  .controls>* { margin:4px; font-size:16px; }
  #timeDisplay { margin-top:6px; font-size:14px; font-style:italic; }
  .canvas-container { position:relative; display:inline-block; margin-bottom:20px; }
  canvas.spectro { background:#000; display:block; }
  canvas.overlay { position:absolute; top:0; left:0; pointer-events:auto; }
  #navButtons { margin:10px; display:none; }
  #navButtons button { margin:0 6px; font-size:16px; padding:6px 12px; }
</style>
</head>
<body>

<h1>Fixed Overlay Spectrogram Player</h1>

<div class="controls">
  <input type="file" id="audioFile" accept=".mp3" />
  <label>Speed:
    <select id="speed"><option>1</option><option>2</option><option>4</option><option>30</option><option>60</option><option>120</option></select>×
  </label>
  <button id="startBtn">Play (Phase 1)</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="saveBtn">Download PNG</button>
  <div id="timeDisplay">No file loaded.</div>
  <div id="durationDisplay"></div>
</div>

<div id="rowsContainer"></div>

<div id="navButtons">
  <button id="back15">◀ 15s</button>
  <button id="masterToggle">Play/Pause</button>
  <button id="forward15">15s ▶</button>
</div>

<script>
const canvasWidth = window.innerWidth;
const canvasHeight = 300;
const tickHeight = 10;
const labelHeight = 20;
const usableHeight = canvasHeight - tickHeight - labelHeight;
const labelInterval = 100, labelPadding = 6;

let audio, audioCtx, analyser, dataArray;
let drawX=0, spectrogramComplete=false, isPaused=false, animationId;
let spectroCanvases=[], overlayCanvases=[], rowTimestamps=[], finalDrawX=canvasWidth;

let phase2Audio=null, phase2Playing=false;

function formatTime(s){
  const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=Math.floor(s%60);
  return `${h}h${m}m${sec}s`;
}

function updatePhase1TimeDisplay(){
  if(audio){
    timeDisplay.textContent = `Processing: ${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
  }
}

function createNewRow(){
  const rowDiv=document.createElement('div');
  rowDiv.className='canvas-container';

  const sc=document.createElement('canvas');
  sc.width=canvasWidth; sc.height=canvasHeight;
  sc.className='spectro';
  const sctx=sc.getContext('2d');
  sctx.fillStyle='#000'; sctx.fillRect(0,0,canvasWidth,canvasHeight);
  rowDiv.appendChild(sc);
  spectroCanvases.push({canvas:sc,ctx:sctx});

  const ov=document.createElement('canvas');
  ov.width=canvasWidth; ov.height=canvasHeight;
  ov.className='overlay';
  const ovctx=ov.getContext('2d');
  rowDiv.appendChild(ov);
  overlayCanvases.push({canvas:ov,ctx:ovctx});

  rowTimestamps.push(audio.currentTime);
  finalDrawX = canvasWidth;

  rowsContainer.appendChild(rowDiv);
  drawX=0;
}

function drawSpectrogram(){
  if(!audio||audio.paused||audio.ended||isPaused)return;
  analyser.getByteFrequencyData(dataArray);

  if(drawX>=canvasWidth) createNewRow();
  const {ctx}=spectroCanvases[spectroCanvases.length-1];
  for(let y=0;y<analyser.frequencyBinCount;y++){
    const v=dataArray[y];
    ctx.fillStyle=`hsl(${v*1.5},100%,50%)`;
    ctx.fillRect(drawX,usableHeight-y,1,1);
  }

  const elapsed=Math.floor(audio.currentTime);
  if(elapsed%60===0){
    ctx.strokeStyle='#fff';
    ctx.lineWidth=(elapsed%900===0?2:1);
    ctx.beginPath();
    ctx.moveTo(drawX+0.5,usableHeight);
    ctx.lineTo(drawX+0.5,usableHeight+tickHeight);
    ctx.stroke();
  }

  if(drawX%labelInterval===0){
    const label=formatTime(audio.currentTime);
    const tw=ctx.measureText(label).width;
    ctx.fillStyle='#000';
    ctx.fillRect(drawX-tw/2-labelPadding,usableHeight+tickHeight,tw+2*labelPadding,labelHeight);
    ctx.fillStyle='#fff';
    ctx.textAlign='center';
    ctx.textBaseline='top';
    ctx.font='12px sans-serif';
    ctx.fillText(label,drawX,usableHeight+tickHeight+2);
  }

  drawX++;
  finalDrawX = drawX;
  updatePhase1TimeDisplay();
  animationId=requestAnimationFrame(drawSpectrogram);

  if(audio.ended||audio.currentTime>=audio.duration){
    spectrogramComplete=true;
    // Fill checkerboard only up to finalDrawX
    const last = spectroCanvases[spectroCanvases.length-1];
    const ctx2 = last.ctx;
    const fillTo = finalDrawX;
    if(fillTo<canvasWidth){
      const sq=6;
      for(let x=fillTo;x<canvasWidth;x+=sq){
        for(let y=0;y<usableHeight;y+=sq){
          const light = ((Math.floor(x/sq)^Math.floor(y/sq))%2)==0;
          ctx2.fillStyle = light?'#444':'#222';
          ctx2.fillRect(x,y,sq,sq);
        }
      }
    }

    // Adjust final overlay width
    const ovLast = overlayCanvases[overlayCanvases.length-1];
    ovLast.canvas.width = finalDrawX;
    ovLast.ctx.clearRect(0,0,finalDrawX,canvasHeight);

    navButtons.style.display='block';
    audio.currentTime=0;
    setupPhase2();
  }
}

function setupPhase2(){
  if(!spectrogramComplete)return;
  if(phase2Audio){ phase2Audio.pause(); phase2Audio=null; }
  phase2Audio = new Audio(URL.createObjectURL(fileInput.files[0]));
  phase2Audio.preload='auto'; phase2Audio.playbackRate=1; phase2Audio.crossOrigin='anonymous';
  phase2Playing=false;

  overlayCanvases.forEach(({canvas})=>{
    canvas.style.pointerEvents='auto';
  });
  overlayCanvases.forEach(({canvas,ctx},idx)=>{
    canvas.addEventListener('click',e=>{
      const rect=canvas.getBoundingClientRect();
      const x=e.clientX-rect.left;
      const t0=rowTimestamps[idx];
      const t1=rowTimestamps[idx+1]||phase2Audio.duration;
      const w=canvas.width;
      const seekTime=t0 + (x/w)*(t1-t0);
      phase2Audio.currentTime=seekTime;
      if(!phase2Playing) phase2Audio.play();
      drawPhase2Cursor();
    });
  });

  navButtons.style.display='block';
  phase2Audio.addEventListener('play',()=>{phase2Playing=true; masterToggle.textContent='Pause';});
  phase2Audio.addEventListener('pause',()=>{phase2Playing=false; masterToggle.textContent='Play';});
  phase2Audio.addEventListener('ended',()=>{phase2Playing=false; masterToggle.textContent='Play';});
  drawPhase2Cursor();
  setInterval(drawPhase2Cursor,100);
}

function drawPhase2Cursor(){
  if(!phase2Audio)return;
  overlayCanvases.forEach(({canvas,ctx},idx)=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const t=phase2Audio.currentTime;
    const t0=rowTimestamps[idx], t1=rowTimestamps[idx+1]||phase2Audio.duration;
    if(t<t0||t>t1)return;
    const x = ((t-t0)/(t1-t0))*canvas.width;
    // red-white-black borders
    ctx.lineWidth=5; ctx.strokeStyle='red';
    ctx.beginPath(); ctx.moveTo(x+0.5,0); ctx.lineTo(x+0.5,canvas.height); ctx.stroke();
    ctx.lineWidth=3; ctx.strokeStyle='white';
    ctx.beginPath(); ctx.moveTo(x+0.5,0); ctx.lineTo(x+0.5,canvas.height); ctx.stroke();
    ctx.lineWidth=1; ctx.strokeStyle='black';
    ctx.beginPath(); ctx.moveTo(x+0.5,0); ctx.lineTo(x+0.5,canvas.height); ctx.stroke();
  });
  if(phase2Audio) timeDisplay.textContent = `Playback Time: ${formatTime(phase2Audio.currentTime)} / ${formatTime(phase2Audio.duration)}`;
}

// Controls
back15.onclick = ()=>{ if(phase2Audio) phase2Audio.currentTime=Math.max(0,phase2Audio.currentTime-15); drawPhase2Cursor(); };
forward15.onclick = ()=>{ if(phase2Audio) phase2Audio.currentTime=Math.min(phase2Audio.duration,phase2Audio.currentTime+15); drawPhase2Cursor(); };
masterToggle.onclick = ()=>{
  if(!phase2Audio)return;
  if(phase2Playing) phase2Audio.pause();
  else phase2Audio.play().catch(()=>{phase2Audio.load();phase2Audio.play();});
};
startBtn.onclick = ()=>{
  if(!fileInput.files[0])return alert('Select a file.');
  if(audio){ audio.pause(); audio=null; }
  audio = new Audio(URL.createObjectURL(fileInput.files[0]));
  audio.crossOrigin='anonymous';
  audio.preload='auto';
  audio.playbackRate=Number(speedSelect.value);
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const src=audioCtx.createMediaElementSource(audio);
  analyser=audioCtx.createAnalyser(); analyser.fftSize=2048;
  src.connect(analyser); analyser.connect(audioCtx.destination);
  dataArray=new Uint8Array(analyser.frequencyBinCount);

  spectrogramComplete=false; rowTimestamps=[]; spectroCanvases=[]; overlayCanvases=[];
  rowsContainer.innerHTML=''; startBtn.disabled=true; pauseBtn.disabled=false;
  createNewRow();
  audio.onended=()=>{ spectrogramComplete=true; navButtons.style.display='block'; audio.currentTime=0; setupPhase2(); };
  audio.play(); drawSpectrogram();
};
pauseBtn.onclick = ()=>{ if(audio){ isPaused= !isPaused; if(isPaused) audio.pause(); else audio.play(); } };
saveBtn.onclick = ()=>{};
fileInput.onchange = ()=>{
  const temp=new Audio(URL.createObjectURL(fileInput.files[0]));
  temp.onloadedmetadata=()=> durationDisplay.textContent='Total Duration: '+formatTime(temp.duration);
};
</script>
</body>
</html>
