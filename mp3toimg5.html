<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Spectrogram with Extrapolated Phase 1 & Accurate Phase 2</title>
<style>
  body { background:#111; color:#fff; font-family:sans-serif; margin:0; text-align:center }
  .controls {padding:10px;}
  .controls>* {margin:4px; font-size:16px;}
  #timeDisplay {margin-top:6px; font-size:14px; font-style:italic;}
  .canvas-container {position:relative; display:inline-block; margin-bottom:20px;}
  canvas.spectro {background:#000; display:block;}
  canvas.overlay {position:absolute; left:0; top:0; pointer-events:auto;}
  #navButtons {margin:10px; display:none;}
  #navButtons button {margin:0 6px; font-size:16px; padding:6px 12px;}
</style>
</head>
<body>

<h1>Spectrogram with Extrapolated End & Precise Phase 2</h1>

<div class="controls">
  <input type="file" id="audioFile" accept=".mp3" />
  <label>Speed:
    <select id="speed"><option>1</option><option>2</option><option>4</option>
    <option>30</option><option>60</option><option>120</option></select>×
  </label>
  <button id="startBtn">Play (Phase 1)</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="saveBtn">Download PNG</button>
  <div id="timeDisplay">No file loaded.</div>
</div>

<div id="rowsContainer"></div>

<div id="navButtons">
  <button id="back15">◀ 15s</button>
  <button id="masterToggle">Play/Pause</button>
  <button id="forward15">15s ▶</button>
</div>

<script>
const WIDTH = window.innerWidth, HEIGHT = 300;
const tickH = 10, labelH = 20, usableH = HEIGHT - tickH - labelH;
const labelInterval = 100, pad = 6;

const fileInput = document.getElementById('audioFile'),
      speedSelect = document.getElementById('speed'),
      startBtn = document.getElementById('startBtn'),
      pauseBtn = document.getElementById('pauseBtn'),
      saveBtn = document.getElementById('saveBtn'),
      timeDisplay = document.getElementById('timeDisplay'),
      rows = document.getElementById('rowsContainer'),
      nav = document.getElementById('navButtons'),
      back15 = document.getElementById('back15'),
      master = document.getElementById('masterToggle'),
      fwd15 = document.getElementById('forward15');

let audio1, audio2, ctx1, analyser, data, drawX=0;
let spectro=[], overlay=[], timestamps=[], complete=false, paused=false;
let postLoop, phase2Playing=false;

function fmt(s){
  const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=Math.floor(s%60);
  return `${h}h${m}m${sec}s`;
}
function upd1(){
  if(audio1)
    timeDisplay.textContent = `Processing ${fmt(audio1.currentTime)}/${fmt(audio1.duration)}`;
}
function createRow(){
  const div=document.createElement('div'); div.className='canvas-container';
  const s=document.createElement('canvas'); s.width=WIDTH; s.height=HEIGHT; s.className='spectro';
  const sc=s.getContext('2d'); sc.fillStyle='#000'; sc.fillRect(0,0,WIDTH,HEIGHT);
  div.appendChild(s); spectro.push({canvas:s,ctx:sc});
  const ov=document.createElement('canvas'); ov.width=WIDTH; ov.height=HEIGHT; ov.className='overlay';
  const ovctx=ov.getContext('2d'); div.appendChild(ov); overlay.push({canvas:ov,ctx:ovctx});
  const t = audio1.currentTime;
  timestamps.push(t);
  rows.appendChild(div);
  drawX=0;
}
function draw1(){
  if(!audio1||audio1.paused||paused) return;
  analyser.getByteFrequencyData(data);
  if(drawX>=WIDTH) createRow();
  const c = spectro[spectro.length-1].ctx;
  for(let y=0;y<analyser.frequencyBinCount;y++){
    const v=data[y]; c.fillStyle=`hsl(${v*1.5},100%,50%)`;
    c.fillRect(drawX, usableH - y,1,1);
  }
  let tsec=Math.floor(audio1.currentTime);
  if(tsec%60==0){
    c.strokeStyle='#fff'; c.lineWidth=(tsec%900?1:2);
    c.beginPath(); c.moveTo(drawX+.5, usableH); c.lineTo(drawX+.5,usableH+tickH); c.stroke();
  }
  if(drawX%labelInterval==0){
    const lab=fmt(audio1.currentTime), w=c.measureText(lab).width;
    c.fillStyle='#000'; c.fillRect(drawX-w/2-pad, usableH+tickH, w+2*pad,labelH);
    c.fillStyle='#fff'; c.textAlign='center'; c.textBaseline='top';
    c.font='12px sans-serif'; c.fillText(lab,drawX,usableH+tickH+2);
  }
  drawX++;
  upd1();
  requestAnimationFrame(draw1);
}

function finalize(){
  const last = spectro[spectro.length-1].ctx;
  if(drawX<WIDTH){
    const sz=6;
    for(let x=drawX;x<WIDTH;x+=sz)
      for(let y=0;y<usableH;y+=sz){
        last.fillStyle = ((x/sz)^(y/sz))%2?'#444':'#222';
        last.fillRect(x,y,sz,sz);
      }
  }
}
function postProcess(){
  if(drawX>=WIDTH){
    timestamps.push(audio1.duration + ((drawX-WIDTH)/WIDTH)*(audio1.duration - timestamps[timestamps.length-1]));
    clearInterval(postLoop);
    complete=true; setup2();
    return;
  }
  const c = spectro[spectro.length-1].ctx;
  analyser.getByteFrequencyData(data);
  for(let y=0;y<analyser.frequencyBinCount;y++){
    const v=data[y]; c.fillStyle=`hsl(${v*1.5},100%,50%)`;
    c.fillRect(drawX, usableH - y,1,1);
  }
  drawX++;
}

function drawOverlay(){
  if(!complete||!audio2) return;
  overlay.forEach((o,i)=>{
    o.ctx.clearRect(0,0,WIDTH,HEIGHT);
    const t0=timestamps[i], t1=timestamps[i+1]||audio2.duration;
    if(audio2.currentTime<t0||audio2.currentTime>t1) return;
    const x = ((audio2.currentTime - t0)/(t1-t0))*WIDTH;
    ['red5','white3','black1'].forEach((col,width,i2)=>{
      o.ctx.lineWidth = parseInt(col.match(/\d+/)[0]);
      o.ctx.strokeStyle = col.replace(/\d+/,'');
      o.ctx.beginPath();
      o.ctx.moveTo(x+.5,0); o.ctx.lineTo(x+.5,HEIGHT); o.ctx.stroke();
    });
  });
}

function setup2(){
  audio2 = new Audio(URL.createObjectURL(fileInput.files[0]));
  audio2.preload='auto'; audio2.playbackRate=1; audio2.crossOrigin='anonymous';
  overlay.forEach((o,i)=>{
    o.canvas.style.pointerEvents='auto';
    o.canvas.onclick = e=>{
      const x = e.offsetX, t0=timestamps[i], t1=timestamps[i+1]||audio2.duration;
      audio2.currentTime = t0 + (x/WIDTH)*(t1-t0);
      if(!phase2Playing) audio2.play();
      drawOverlay();
    };
  });
  nav.style.display = 'block';
  audio2.onplay = ()=>{phase2Playing=true; master.textContent='Pause';};
  audio2.onpause = ()=>{phase2Playing=false; master.textContent='Play';};
  audio2.onended = ()=>{phase2Playing=false; master.textContent='Play';};
  audio2.ontimeupdate = ()=>{drawOverlay(); timeDisplay.textContent = `Playback: ${fmt(audio2.currentTime)}/${fmt(audio2.duration)}`;};
  master.onclick = ()=>{ if(phase2Playing) audio2.pause(); else audio2.play(); };
  back15.onclick = ()=>{audio2.currentTime = Math.max(0,audio2.currentTime-15);};
  fwd15.onclick = ()=>{audio2.currentTime = Math.min(audio2.duration,audio2.currentTime+15);};
  audio2.play();
  postLoop = setInterval(postProcess,0);
}

startBtn.onclick = ()=>{
  if(!fileInput.files[0]) return alert('Please select an MP3.');
  audio1 && audio1.pause();
  clearInterval(postLoop);
  spectro=[], overlay=[], timestamps=[], complete=false;
  drawX=0; rows.innerHTML=''; nav.style.display='none';
  audio1 = new Audio(URL.createObjectURL(fileInput.files[0]));
  audio1.preload='auto'; audio1.playbackRate=Number(speedSelect.value); audio1.crossOrigin='anonymous';
  audio1.onended = ()=>{
    finalize();
    postLoop = setInterval(postProcess,0);
  };
  const audCtx = new (window.AudioContext||window.webkitAudioContext)();
  const src = audCtx.createMediaElementSource(audio1);
  analyser = audCtx.createAnalyser(); analyser.fftSize=2048;
  src.connect(analyser); analyser.connect(audCtx.destination);
  data = new Uint8Array(analyser.frequencyBinCount);
  createRow();
  audio1.play();
  paused=false; pauseBtn.disabled=false;
  draw1();
};

pauseBtn.onclick = ()=>{
  if(!audio1)return;
  if(paused) {audio1.play(); draw1();} else {audio1.pause(); clearInterval(postLoop);}
  paused=!paused;
};
</script>

</body>
</html>
