<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Spectrogram Phase 1 Completion Fill + Phase 2</title>
<style>
  body { background:#111; color:#fff; font-family:sans-serif; margin:0; text-align:center }
  .controls { padding:10px }
  .controls>* { margin:4px; font-size:16px }
  #timeDisplay { margin-top:6px; font-size:14px; font-style:italic }
  .canvas-container { position:relative; display:inline-block; margin-bottom:20px }
  canvas.spectro { background:#000; display:block }
  canvas.overlay {
    position:absolute; left:0; top:0; pointer-events:auto
  }
  #navButtons { margin:10px; display:none }
  #navButtons button { margin:0 6px; font-size:16px; padding:6px 12px }
</style>
</head>
<body>

<h1>Spectrogram with End Fill + Phase 2</h1>

<div class="controls">
  <input type="file" id="audioFile" accept=".mp3">
  <label>Speed:
    <select id="speed"><option>1</option><option>2</option><option>4</option><option>30</option><option>60</option><option>120</option></select>×
  </label>
  <button id="startBtn">Play (Phase 1)</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="saveBtn">Download PNG</button>
  <div id="timeDisplay">No file</div>
  <div id="durationDisplay"></div>
</div>

<div id="rowsContainer"></div>
<div id="navButtons">
  <button id="back15">◀ 15s</button>
  <button id="masterToggle">Play/Pause</button>
  <button id="forward15">15s ▶</button>
</div>

<script>
const W = window.innerWidth, H = 300, tickH=10, labH=20, usableH=H-tickH-labH;
const labelInterval=100,labelPad=6;

let masterAudio, audioCtx, analyser, dataArray;
let drawX=0, spectComplete=false, isPaused=false, anim;
let spectroRows=[], overlayRows=[], rowTimestamps=[];
let phase2, phase2Playing=false;

function fmt(t){const h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=Math.floor(t%60); return `${h}h${m}m${s}s`;}
function updateTime(){ 
  if(masterAudio) {
    const c=masterAudio.currentTime, d=masterAudio.duration||0;
    document.getElementById('timeDisplay').textContent = `Phase 1: ${fmt(c)} / ${fmt(d)}`;
  }
}

function newRow(){
  const d = document.createElement('div'); d.className='canvas-container';
  const c=document.createElement('canvas'); c.width=W; c.height=H; c.className='spectro';
  const ctx=c.getContext('2d'); ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
  d.appendChild(c); spectroRows.push({c,ctx});
  const o=document.createElement('canvas'); o.width=W; o.height=H; o.className='overlay';
  const oct=o.getContext('2d'); d.appendChild(o); overlayRows.push({c:o,ctx:oct});
  rowTimestamps.push(masterAudio.currentTime);
  document.getElementById('rowsContainer').appendChild(d);
  drawX=0;
}

function drawSpectrogram(){
  if(!masterAudio || masterAudio.paused||isPaused) return;
  analyser.getByteFrequencyData(dataArray);
  if(drawX>=W) newRow();
  const ctx=spectroRows[spectroRows.length-1].ctx;
  for(let y=0;y<analyser.frequencyBinCount;y++){
    const v=dataArray[y],col=`hsl(${v*1.5},100%,50%)`;
    ctx.fillStyle=col; ctx.fillRect(drawX,usableH-y,1,1);
  }
  const e=Math.floor(masterAudio.currentTime);
  if(e%60===0){
    ctx.strokeStyle='#fff'; ctx.lineWidth=e%900===0?2:1;
    ctx.beginPath(); ctx.moveTo(drawX+0.5,usableH); ctx.lineTo(drawX+0.5,usableH+tickH); ctx.stroke();
  }
  if(drawX%labelInterval===0){
    const lab=fmt(masterAudio.currentTime),tw=ctx.measureText(lab).width;
    ctx.fillStyle='#000';
    ctx.fillRect(drawX-tw/2-labelPad,usableH+tickH,tw+2*labelPad,labH);
    ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='top';
    ctx.font='12px sans-serif'; ctx.fillText(lab,drawX,usableH+tickH+2);
  }
  drawX++; updateTime();
  anim=requestAnimationFrame(drawSpectrogram);
  if(masterAudio.currentTime>=masterAudio.duration){
    spectComplete=true;
    fillToEnd();
  }
}

function fillToEnd(){
  cancelAnimationFrame(anim);
  const d=masterAudio.duration;
  const lastCtx = spectroRows[spectroRows.length-1].ctx;
  const ws=W-drawX;
  const incrementTime = d / (masterAudio.duration*masterAudio.playbackRate) / 60; // approximate filler
  let extraCols = W - drawX;
  let t=masterAudio.duration;
  const fillFn = ()=>{
    if(extraCols<=0){ startPhase2(); return; }
    // fill discretely:
    lastCtx.fillStyle='#333';
    lastCtx.fillRect(drawX, usableH - analyser.frequencyBinCount, extraCols, analyser.frequencyBinCount);
    drawX=W;
    rowTimestamps[rowTimestamps.length-1] = t;
    startPhase2();
  };
  fillFn();
}

function setupPhase2(){
  document.getElementById('navButtons').style.display='block';
  phase2=new Audio(URL.createObjectURL(fileInput.files[0]));
  phase2.preload='auto'; phase2.crossOrigin='anonymous'; phase2.playbackRate=1;
  
  overlayRows.forEach((o,i)=>{
    o.c.style.pointerEvents='auto';
    o.c.addEventListener('click',e=>{
      const rect=o.c.getBoundingClientRect(),x=e.clientX-rect.left;
      const t0=rowTimestamps[i], t1=rowTimestamps[i+1]||phase2.duration;
      phase2.currentTime=(t0 + x/W*(t1 - t0));
      if(!phase2Playing) phase2.play();
      drawPhase2Cursor();
    });
  });
  
  phase2.addEventListener('ended',()=>{phase2Playing=false; masterToggle.textContent='Play'; clearInterval(phase2.timer)});
  phase2.addEventListener('play',()=>{phase2Playing=true; masterToggle.textContent='Pause'; setupCursor();}
  );
  phase2.addEventListener('pause',()=>{phase2Playing=false; masterToggle.textContent='Play'; clearInterval(phase2.timer)});
}

function startPhase2(){
  setupPhase2();
  phase2.play();
}

function drawPhase2Cursor(){
  if(!phase2) return;
  overlayRows.forEach((o,i)=>{
    o.ctx.clearRect(0,0,W,H);
    const t=phase2.currentTime, t0=rowTimestamps[i],t1=rowTimestamps[i+1]||phase2.duration;
    if(t<t0||t>t1) return;
    const x=(t - t0)/(t1 - t0)*W;
    ['#red','#fff','#black'].forEach((col,idx)=>{
      o.ctx.lineWidth = idx===0?5:idx===1?3:1;
      o.ctx.strokeStyle = idx===0?'red':idx===1?'white':'black';
      o.ctx.beginPath(); o.ctx.moveTo(x+0.5,0); o.ctx.lineTo(x+0.5,H); o.ctx.stroke();
    });
  });
}

function setupCursor(){
  clearInterval(phase2.timer);
  phase2.timer=setInterval(drawPhase2Cursor,100);
  drawPhase2Cursor();
}

function updatePhase2Time(){
  document.getElementById('timeDisplay').textContent = `Phase 2: ${fmt(phase2.currentTime)} / ${fmt(phase2.duration)}`;
}

document.getElementById('startBtn').onclick = ()=>{
  const f=fileInput.files[0];
  if(!f){alert('Select file');return;}
  masterAudio= new Audio(URL.createObjectURL(f));
  masterAudio.preload='auto';
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  analyser=audioCtx.createAnalyser();
  audioCtx.createMediaElementSource(masterAudio).connect(analyser);
  analyser.connect(audioCtx.destination);
  analyser.fftSize=512;
  dataArray=new Uint8Array(analyser.frequencyBinCount);
  spectComplete=false;
  drawX=0;
  spectroRows=[]; overlayRows=[]; rowTimestamps=[];
  document.getElementById('rowsContainer').innerHTML='';
  document.getElementById('navButtons').style.display='none';
  newRow(); masterAudio.play(); anim=requestAnimationFrame(drawSpectrogram);
  document.getElementById('pauseBtn').disabled=false;
};

document.getElementById('pauseBtn').onclick = ()=>{
  if(!masterAudio) return;
  if(isPaused){masterAudio.play();anim=requestAnimationFrame(drawSpectrogram);isPaused=false}
  else{masterAudio.pause();cancelAnimationFrame(anim);isPaused=true;}
};

document.getElementById('back15').onclick = ()=>{ phase2.currentTime = Math.max(0,phase2.currentTime-15); drawPhase2Cursor();}
document.getElementById('forward15').onclick = ()=>{ phase2.currentTime = Math.min(phase2.duration,phase2.currentTime+15); drawPhase2Cursor();}
document.getElementById('masterToggle').onclick = ()=>{ phase2Playing ? phase2.pause(): phase2.play(); }

document.getElementById('saveBtn').onclick = ()=>{
  // flatten PNG logic ...
};

fileInput.onchange = ()=>{
  const f = fileInput.files[0];
  if(!f) return;
  const tmp = document.createElement('audio');
  tmp.src = URL.createObjectURL(f);
  tmp.onloadedmetadata = ()=>document.getElementById('durationDisplay').textContent = fmt(tmp.duration);
};
</script>
</body>
</html>
