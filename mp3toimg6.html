<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spectrogram Player with Notation</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      text-align: center;
      user-select: none;
    }
    .controls {
      padding: 10px;
    }
    .controls > * {
      margin: 6px;
      font-size: 16px;
    }
    #timeStatus {
      margin-top: 6px;
      font-size: 14px;
      font-style: italic;
    }
    .canvasRowContainer {
      position: relative;
      display: inline-block;
      margin-bottom: 40px; /* extra space for notation track */
      user-select: none;
    }
    canvas.spectrogramCanvas {
      background: #000;
      display: block;
      position: relative;
      z-index: 1;
    }
    canvas.cursorOverlayCanvas {
      position: absolute;
      left: 0;
      top: 0;
      pointer-events: auto;
      z-index: 3;
    }
    canvas.notationCanvas {
      display: block;
      position: absolute;
      left: 0;
      height: 20px;
      bottom: 22px; /* 2px below time label area (which is 20px) */
      z-index: 2;
      cursor: crosshair;
      background: #222;
      user-select: none;
    }
    #playerControls {
      margin: 10px;
      display: none;
    }
    #playerControls button,
    #notationControls button {
      margin: 0 6px;
      font-size: 16px;
      padding: 6px 12px;
      cursor: pointer;
      user-select: none;
    }
    #notationControls {
      margin-top: 10px;
      margin-bottom: 20px;
      user-select: none;
    }
    #notationControls > button {
      border: none;
      outline: none;
      width: 30px;
      height: 30px;
      vertical-align: middle;
      border-radius: 4px;
    }
    #notationControls > button.selected {
      outline: 3px solid #fff;
    }
    #modeToggle {
      margin-left: 20px;
      font-weight: bold;
      cursor: pointer;
      padding: 6px 12px;
      background: #444;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <h1>Spectrogram Player with Notation</h1>

  <div class="controls">
    <input type="file" id="fileInput" accept=".mp3" />
    <label> Speed:
      <select id="playbackSpeedSelect">
        <option>1</option><option>2</option><option>4</option>
        <option>30</option><option>60</option><option>120</option>
      </select> ×
    </label>
    <button id="startGenerateButton">Play (Phase 1)</button>
    <button id="pauseGenerateButton" disabled>Pause</button>
    <button id="exportButton">Download Spectrogram</button>
    <div id="timeStatus">No file loaded.</div>
    <div id="fileDurationStatus"></div>
  </div>

  <div id="playerControls">
    <button id="rewind15Seconds">◀ 15 s</button>
    <button id="playPauseButton">Play/Pause</button>
    <button id="forward15Seconds">15 s ▶</button>
    <span id="modeToggle" title="Switch between Seek and Edit mode">Mode: Seek</span>
  </div>

  <div id="notationControls" style="display:none;">
    <button class="colorBtn selected" data-color="#ff0000" style="background:#ff0000" title="Red"></button>
    <button class="colorBtn" data-color="#00ff00" style="background:#00ff00" title="Green"></button>
    <button class="colorBtn" data-color="#0000ff" style="background:#0000ff" title="Blue"></button>
    <button class="colorBtn" data-color="#ffff00" style="background:#ffff00" title="Yellow"></button>
    <button class="colorBtn" data-color="#ff00ff" style="background:#ff00ff" title="Magenta"></button>
    <button class="colorBtn" data-color="#00ffff" style="background:#00ffff" title="Cyan"></button>
    <button class="colorBtn" data-color="" title="Eraser" style="background:#444; color:#fff; font-weight:bold;">E</button>
  </div>

  <div id="rowsContainer"></div>

<script>
  const SCREEN_WIDTH = window.innerWidth;
  const ROW_HEIGHT = 300;
  const MINUTE_TICK_HEIGHT = 10;
  const LABEL_AREA_HEIGHT = 20;
  const USEFUL_CANVAS_HEIGHT = ROW_HEIGHT - MINUTE_TICK_HEIGHT - LABEL_AREA_HEIGHT;
  const PIXEL_LABEL_INTERVAL = 100;
  const LABEL_PADDING = 6;

  const fileInput = document.getElementById('fileInput');
  const playbackSpeedSelect = document.getElementById('playbackSpeedSelect');
  const startGenerateButton = document.getElementById('startGenerateButton');
  const pauseGenerateButton = document.getElementById('pauseGenerateButton');
  const exportButton = document.getElementById('exportButton');
  const timeStatus = document.getElementById('timeStatus');
  const fileDurationStatus = document.getElementById('fileDurationStatus');
  const rowsContainer = document.getElementById('rowsContainer');
  const playerControls = document.getElementById('playerControls');
  const rewind15Seconds = document.getElementById('rewind15Seconds');
  const playPauseButton = document.getElementById('playPauseButton');
  const forward15Seconds = document.getElementById('forward15Seconds');
  const modeToggle = document.getElementById('modeToggle');
  const notationControls = document.getElementById('notationControls');
  const colorButtons = notationControls.querySelectorAll('.colorBtn');

  let generatePhaseAudio = null;
  let audioAnalyzer = null;
  let audioDataArray = null;
  let drawXPosition = 0;
  let finalRowWidth = 0;
  let hasFinishedSpectrogram = false;
  let generatePhasePaused = false;
  let generatePhaseAnimationId = null;
  let audioCtx = null;

  // Data containers for spectrogram and overlays
  const spectrogramRows = [];
  const cursorOverlayRows = [];
  const notationCanvasRows = [];
  const rowStartTimeMarkers = [];

  let playbackPhaseAudio = null;
  let playbackPhasePlaying = false;

  // Mode: 'seek' or 'edit'
  let currentMode = 'seek';

  // Current selected color for highlighting (empty string means eraser)
  let currentHighlightColor = '#ff0000';

  // Highlight resolution in pixels (width of each highlight segment)
  const HIGHLIGHT_SEGMENT_WIDTH = 50;

  // Highlight data structure per row: array of colors per segment index
  // notationHighlights[rowIndex] = ['#ff0000', '', '#00ff00', ...]
  const notationHighlights = [];

  // Variables to track mouse dragging in edit mode
  let isDraggingHighlight = false;
  let dragStartX = 0;
  let dragCurrentX = 0;
  let dragRowIndex = null;

  // ----------------- Utility --------------------
  function formatTime(t) {
    const h = Math.floor(t/3600);
    const m = Math.floor((t%3600)/60);
    const s = Math.floor(t%60);
    return `${h}h${m}m${s}s`;
  }

  function updateTimeStatus() {
    if (!generatePhaseAudio) {
      timeStatus.textContent = 'No file loaded.';
      return;
    }
    if (!hasFinishedSpectrogram && generatePhaseAudio) {
      const cur = generatePhaseAudio.currentTime, dur = generatePhaseAudio.duration || 0;
      timeStatus.textContent = `Processing: ${formatTime(cur)} / ${formatTime(dur)}`;
    } else if (playbackPhaseAudio) {
      timeStatus.textContent = `Playback: ${formatTime(playbackPhaseAudio.currentTime)} / ${formatTime(playbackPhaseAudio.duration)}`;
    }
  }

  // ----------------- Spectrogram Generation Phase --------------------

  function createSpectrogramRow() {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'canvasRowContainer';

    // Spectrogram canvas
    const spectroCanvas = document.createElement('canvas');
    spectroCanvas.width = SCREEN_WIDTH;
    spectroCanvas.height = ROW_HEIGHT;
    spectroCanvas.className = 'spectrogramCanvas';
    const spectroCtx = spectroCanvas.getContext('2d');
    spectroCtx.fillStyle = '#000';
    spectroCtx.fillRect(0, 0, SCREEN_WIDTH, ROW_HEIGHT);
    rowDiv.appendChild(spectroCanvas);
    spectrogramRows.push({ canvas: spectroCanvas, ctx: spectroCtx });

    // Notation canvas (20px high, positioned 2px below label)
    const notationCanvas = document.createElement('canvas');
    notationCanvas.width = SCREEN_WIDTH;
    notationCanvas.height = 20;
    notationCanvas.className = 'notationCanvas';
    notationCanvas.style.position = 'absolute';
    notationCanvas.style.left = '0';
    notationCanvas.style.bottom = '22px'; // 2px below label area (20px)
    rowDiv.appendChild(notationCanvas);
    const notationCtx = notationCanvas.getContext('2d');
    notationCanvasRows.push({ canvas: notationCanvas, ctx: notationCtx });

    // Cursor overlay canvas (for red vertical playback line)
    const overlayCanvas = document.createElement('canvas');
    overlayCanvas.width = SCREEN_WIDTH;
    overlayCanvas.height = ROW_HEIGHT;
    overlayCanvas.className = 'cursorOverlayCanvas';
    rowDiv.appendChild(overlayCanvas);
    const overlayCtx = overlayCanvas.getContext('2d');
    cursorOverlayRows.push({ canvas: overlayCanvas, ctx: overlayCtx });

    // Start time of this row
    rowStartTimeMarkers.push(generatePhaseAudio.currentTime);

    // Initialize empty highlight data for this row, with segments based on width
    const segmentsCount = Math.ceil(SCREEN_WIDTH / HIGHLIGHT_SEGMENT_WIDTH);
    notationHighlights.push(new Array(segmentsCount).fill(''));

    rowsContainer.appendChild(row
