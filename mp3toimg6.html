<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spectrogram Player with Annotations</title>
  <style>
    body { background: #111; color: #fff; font-family: sans-serif; margin: 0; text-align: center; }
    .controls { padding: 10px; }
    .controls > * { margin: 6px; font-size: 16px; }
    #timeStatus { margin-top: 6px; font-size: 14px; font-style: italic; }
    .canvasRowContainer { position: relative; display: inline-block; margin-bottom: 40px; }
    canvas.spectrogramCanvas { background: #000; display: block; }
    canvas.cursorOverlayCanvas,
    canvas.annotationCanvas { position: absolute; left: 0; pointer-events: auto; }
    canvas.annotationCanvas { top: 300px; height: 20px; }
    #playerControls { margin: 10px; display: none; }
    #playerControls button { margin: 0 6px; font-size: 16px; padding: 6px 12px; }
    #modeToggle, #colorPicker { margin-left: 10px; }
  </style>
</head>
<body>

<h1>Spectrogram Player with Annotations</h1>

<div class="controls">
  <input type="file" id="fileInput" accept=".mp3">
  <label> Speed:
    <select id="playbackSpeedSelect">
      <option>1</option><option>2</option><option>4</option>
      <option>30</option><option>60</option><option>120</option>
    </select> ×
  </label>
  <button id="startGenerateButton">Play (Phase 1)</button>
  <button id="pauseGenerateButton" disabled>Pause</button>
  <button id="exportButton">Download Spectrogram</button>
  <span id="modeToggle">
    Mode:
    <select id="interactionMode">
      <option value="seek">Seek</option>
      <option value="annotate">Annotate</option>
    </select>
  </span>
  <label>
    Color:
    <input type="color" id="colorPicker" value="#00ff00">
    <button id="eraserButton">Eraser</button>
  </label>
  <div id="timeStatus">No file loaded.</div>
  <div id="fileDurationStatus"></div>
</div>

<div id="playerControls">
  <button id="rewind15Seconds">◀ 15 s</button>
  <button id="playPauseButton">Play/Pause</button>
  <button id="forward15Seconds">15 s ▶</button>
</div>

<div id="rowsContainer"></div>

<script>
  const SCREEN_WIDTH = window.innerWidth;
  const ROW_HEIGHT = 300;
  const ANNOTATION_HEIGHT = 20;
  const MINUTE_TICK_HEIGHT = 10;
  const LABEL_AREA_HEIGHT = 20;
  const USEFUL_CANVAS_HEIGHT = ROW_HEIGHT - MINUTE_TICK_HEIGHT - LABEL_AREA_HEIGHT;
  const PIXEL_LABEL_INTERVAL = 100;
  const LABEL_PADDING = 6;
  const ANNOTATION_SEGMENT_WIDTH = 50;

  const fileInput = document.getElementById('fileInput');
  const playbackSpeedSelect = document.getElementById('playbackSpeedSelect');
  const startGenerateButton = document.getElementById('startGenerateButton');
  const pauseGenerateButton = document.getElementById('pauseGenerateButton');
  const exportButton = document.getElementById('exportButton');
  const timeStatus = document.getElementById('timeStatus');
  const fileDurationStatus = document.getElementById('fileDurationStatus');
  const rowsContainer = document.getElementById('rowsContainer');
  const playerControls = document.getElementById('playerControls');
  const rewind15Seconds = document.getElementById('rewind15Seconds');
  const playPauseButton = document.getElementById('playPauseButton');
  const forward15Seconds = document.getElementById('forward15Seconds');
  const interactionMode = document.getElementById('interactionMode');
  const colorPicker = document.getElementById('colorPicker');
  const eraserButton = document.getElementById('eraserButton');

  let currentAnnotationColor = colorPicker.value;
  colorPicker.addEventListener('input', () => currentAnnotationColor = colorPicker.value);
  eraserButton.addEventListener('click', () => currentAnnotationColor = null);

  let generatePhaseAudio = null;
  let audioAnalyzer = null;
  let audioDataArray = null;
  let drawXPosition = 0;
  let finalRowWidth = 0;
  let hasFinishedSpectrogram = false;
  let generatePhasePaused = false;
  let generatePhaseAnimationId = null;
  let audioCtx = null;

  const spectrogramRows = [];
  const cursorOverlayRows = [];
  const annotationRows = [];
  const annotationDataArrays = [];
  const rowStartTimeMarkers = [];

  let playbackPhaseAudio = null;
  let playbackPhasePlaying = false;

  function formatTime(t) {
    const h = Math.floor(t / 3600), m = Math.floor((t % 3600) / 60), s = Math.floor(t % 60);
    return `${h}h${m}m${s}s`;
  }

  function updateTimeStatus() {
    if (!generatePhaseAudio) {
      timeStatus.textContent = 'No file loaded.';
      return;
    }
    const cur = generatePhaseAudio.currentTime, dur = generatePhaseAudio.duration || 0;
    timeStatus.textContent = `Processing: ${formatTime(cur)} / ${formatTime(dur)}`;
  }

  function createSpectrogramRow() {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'canvasRowContainer';

    const spectroCanvas = document.createElement('canvas');
    spectroCanvas.width = SCREEN_WIDTH;
    spectroCanvas.height = ROW_HEIGHT;
    spectroCanvas.className = 'spectrogramCanvas';
    const spectroCtx = spectroCanvas.getContext('2d');
    spectroCtx.fillStyle = '#000';
    spectroCtx.fillRect(0, 0, SCREEN_WIDTH, ROW_HEIGHT);
    rowDiv.appendChild(spectroCanvas);
    spectrogramRows.push({ canvas: spectroCanvas, ctx: spectroCtx });

    const overlayCanvas = document.createElement('canvas');
    overlayCanvas.width = SCREEN_WIDTH;
    overlayCanvas.height = ROW_HEIGHT;
    overlayCanvas.className = 'cursorOverlayCanvas';
    const overlayCtx = overlayCanvas.getContext('2d');
    rowDiv.appendChild(overlayCanvas);
    cursorOverlayRows.push({ canvas: overlayCanvas, ctx: overlayCtx });

    const annotationCanvas = document.createElement('canvas');
    const scale = window.devicePixelRatio || 1;
    annotationCanvas.width = SCREEN_WIDTH * scale;
    annotationCanvas.height = ANNOTATION_HEIGHT * scale;
    annotationCanvas.style.width = SCREEN_WIDTH + 'px';
    annotationCanvas.style.height = ANNOTATION_HEIGHT + 'px';
    annotationCanvas.className = 'annotationCanvas';
    annotationCanvas.style.top = ROW_HEIGHT + 'px';
    annotationCanvas.style.zIndex = 5;
    rowDiv.appendChild(annotationCanvas);

    const segmentCount = Math.ceil(SCREEN_WIDTH / ANNOTATION_SEGMENT_WIDTH);
    const segmentArray = Array(segmentCount).fill(null);
    annotationDataArrays.push(segmentArray);
    annotationRows.push(annotationCanvas);

    setupAnnotationListeners(annotationCanvas, segmentArray);

    rowStartTimeMarkers.push(generatePhaseAudio.currentTime);
    rowsContainer.appendChild(rowDiv);
    drawXPosition = 0;
  }

  function setupAnnotationListeners(canvas, segmentArray) {
    let isDrawing = false;

    canvas.addEventListener('mousedown', e => {
      if (interactionMode.value !== 'annotate') return;
      isDrawing = true;
      paintAnnotationSegment(canvas, e, segmentArray);
    });

    canvas.addEventListener('mousemove', e => {
      if (!isDrawing) return;
      if (interactionMode.value !== 'annotate') return;
      paintAnnotationSegment(canvas, e, segmentArray);
    });

    canvas.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mouseleave', () => isDrawing = false);
  }

  function paintAnnotationSegment(canvas, event, segmentArray) {
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const segmentIndex = Math.floor(x / ANNOTATION_SEGMENT_WIDTH);
    if (segmentIndex < 0 || segmentIndex >= segmentArray.length) {
      console.warn(`Annotation segment out of range: x=${x}, index=${segmentIndex}`);
      return;
    }
    segmentArray[segmentIndex] = currentAnnotationColor || null;
    redrawAnnotationCanvas(canvas, segmentArray);
  }

  function redrawAnnotationCanvas(canvas, segmentArray) {
    const scale = window.devicePixelRatio || 1;
    const ctx = canvas.getContext('2d');
    const width = canvas.width / scale;
    const height = canvas.height / scale;

    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(scale, scale);
    ctx.clearRect(0, 0, width, height);

    segmentArray.forEach((color, i) => {
      const x = i * ANNOTATION_SEGMENT_WIDTH;
      if (color) {
        ctx.fillStyle = color;
        ctx.fillRect(x, 0, ANNOTATION_SEGMENT_WIDTH, height);
        // Debug border:
        // ctx.strokeStyle = '#333';
        // ctx.strokeRect(x, 0, ANNOTATION_SEGMENT_WIDTH, height);
      }
    });

    ctx.restore();
  }

  // Insert your existing spectrogram drawing, playback, and interaction code below...
  // This is just the annotation portion. If you want, I can integrate the entire functional player again.

</script>

</body>
</html>
