<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Growing MP3 Spectrogram</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      margin: 0;
      overflow-x: auto;
    }
    canvas {
      background: black;
      display: block;
      margin: 20px;
      border: 1px solid #444;
    }
    .controls {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #222;
      padding: 10px;
      border-radius: 6px;
      z-index: 100;
    }
    button, select, input {
      margin: 6px;
      padding: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <div class="controls">
    <input type="file" id="audioFile" accept=".mp3" />
    <label for="speed">Speed:</label>
    <select id="speed">
      <option value="1">1×</option>
      <option value="2">2×</option>
      <option value="4">4×</option>
      <option value="30">30×</option>
      <option value="60">60×</option>
      <option value="120">120×</option>
    </select>
    <button id="startBtn">Start</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="saveBtn">Download PNG</button>
  </div>

  <canvas id="spectrogram" height="300"></canvas>

  <script>
    const canvas = document.getElementById("spectrogram");
    const ctx = canvas.getContext("2d");

    const fileInput = document.getElementById("audioFile");
    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const saveBtn = document.getElementById("saveBtn");
    const speedSelect = document.getElementById("speed");

    const labelHeight = 20;
    const usableHeight = canvas.height - labelHeight;

    let audio, audioCtx, analyser, dataArray;
    let playbackRate = 1;
    let isPaused = false;
    let drawX = 0;
    let startTime = 0;
    let animationId;

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return `${m.toString().padStart(2, '0')}m${s.toString().padStart(2, '0')}s`;
    }

    function expandCanvasWidth() {
      const oldCanvas = canvas;
      const oldCtx = ctx;
      const oldWidth = oldCanvas.width;

      // Grow canvas by 1000px when needed
      if (drawX >= oldWidth) {
        const newWidth = oldWidth + 1000;
        const imageData = oldCtx.getImageData(0, 0, oldWidth, canvas.height);

        canvas.width = newWidth;
        ctx.putImageData(imageData, 0, 0);
      }
    }

    function drawSpectrogram() {
      if (!audio || audio.paused || audio.ended || isPaused) {
        return;
      }

      analyser.getByteFrequencyData(dataArray);

      expandCanvasWidth();

      // Draw frequency data
      for (let y = 0; y < dataArray.length; y++) {
        const value = dataArray[y];
        const hue = value * 1.5;
        ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
        ctx.fillRect(drawX, usableHeight - y, 1, 1);
      }

      // Draw time label every 50 pixels
      if (drawX % 50 === 0) {
        const elapsed = (audioCtx.currentTime - startTime) * playbackRate;
        const label = formatTime(elapsed);

        ctx.fillStyle = "black";
        ctx.fillRect(drawX, usableHeight, 50, labelHeight);

        ctx.fillStyle = "white";
        ctx.font = "12px sans-serif";
        ctx.textAlign = "left";
        ctx.fillText(label, drawX + 2, usableHeight + 14);
      }

      drawX++;
      animationId = requestAnimationFrame(drawSpectrogram);
    }

    startBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) {
        alert("Please select an MP3 file.");
        return;
      }

      if (animationId) cancelAnimationFrame(animationId);
      if (audio) {
        audio.pause();
        URL.revokeObjectURL(audio.src);
      }

      const blobURL = URL.createObjectURL(file);
      audio = new Audio(blobURL);
      audio.crossOrigin = "anonymous";
      playbackRate = parseFloat(speedSelect.value);
      audio.playbackRate = playbackRate;

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioCtx.createMediaElementSource(audio);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 512;
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      source.connect(analyser);
      analyser.connect(audioCtx.destination);

      // Reset state
      canvas.width = 1000;
      drawX = 0;
      isPaused = false;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      pauseBtn.textContent = "Pause";
      pauseBtn.disabled = false;
      startTime = audioCtx.currentTime;

      audio.play();
      drawSpectrogram();
    });

    pauseBtn.addEventListener("click", () => {
      if (!audio) return;

      if (!isPaused) {
        isPaused = true;
        audio.pause();
        cancelAnimationFrame(animationId);
        pauseBtn.textContent = "Resume";
      } else {
        isPaused = false;
        audio.play();
        startTime = audioCtx.currentTime - (audio.currentTime / playbackRate);
        drawSpectrogram();
        pauseBtn.textContent = "Pause";
      }
    });

    saveBtn.addEventListener("click", () => {
      const url = canvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = url;
      a.download = "spectrogram.png";
      a.click();
    });
  </script>

</body>
</html>
