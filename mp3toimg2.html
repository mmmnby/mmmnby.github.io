<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wrapped Spectrogram Viewer with Ticks & Controls</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    .controls, .info, .complete-controls {
      padding: 10px;
    }

    .controls button,
    .controls select,
    .controls input,
    .complete-controls button {
      padding: 8px 12px;
      font-size: 16px;
      margin: 8px;
    }

    .canvas-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    canvas {
      background: black;
      display: block;
      margin: 10px 0;
    }

    .info div {
      margin: 4px 0;
    }
  </style>
</head>
<body>

  <h1>Wrapped Spectrogram Viewer</h1>

  <div class="controls">
    <input type="file" id="audioFile" accept=".mp3" />
    <label for="speed">Speed:</label>
    <select id="speed">
      <option value="1">1×</option>
      <option value="2">2×</option>
      <option value="4">4×</option>
      <option value="30">30×</option>
      <option value="60">60×</option>
      <option value="120">120×</option>
    </select>
    <button id="startBtn">Start</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="saveBtn">Download PNG</button>
  </div>

  <div class="info" id="info">
    <div id="fileInfo">File: –</div>
    <div id="durationInfo">Duration: –</div>
    <div id="currentTimeInfo">Current: –</div>
    <div id="statusInfo">Status: Waiting</div>
  </div>

  <div class="canvas-container" id="canvasContainer"></div>

  <div class="complete-controls" id="completeControls" style="display:none;">
    <button id="back15">« 15s</button>
    <button id="playPauseEnd">Play/Pause</button>
    <button id="forward15">15s »</button>
  </div>

  <script>
    const container = document.getElementById("canvasContainer");
    const fileInput = document.getElementById("audioFile");
    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const saveBtn = document.getElementById("saveBtn");
    const speedSelect = document.getElementById("speed");

    const fileInfoEl = document.getElementById("fileInfo");
    const durationInfoEl = document.getElementById("durationInfo");
    const currentTimeEl = document.getElementById("currentTimeInfo");
    const statusEl = document.getElementById("statusInfo");
    const completeControls = document.getElementById("completeControls");
    const back15Btn = document.getElementById("back15");
    const playPauseEndBtn = document.getElementById("playPauseEnd");
    const forward15Btn = document.getElementById("forward15");

    const canvasWidth = window.innerWidth;
    const canvasHeight = 300;
    const labelHeight = 20;
    const tickHeight = 20;
    const graphHeight = canvasHeight - tickHeight - labelHeight;
    const usableHeight = graphHeight;

    const labelInterval = 100;
    const minorTickSec = 60;
    const majorTickSec = 15 * 60;

    let playbackRate = 1;
    let audio, audioCtx, analyser, dataArray;
    let currentCanvas, ctx;
    let drawX = 0;
    let isPaused = false;
    let animationId;
    let lineCount = 0;
    let totalDuration = 0;

    function formatTimeHMS(s) {
      const hrs = Math.floor(s / 3600);
      const mins = Math.floor((s % 3600) / 60);
      const secs = Math.floor(s % 60);
      return `${hrs}h${mins}m${secs}s`;
    }

    function padLabelWidth(text) {
      // padding left/right of 4px
      return ctx.measureText(text).width + 8;
    }

    function createNewCanvas() {
      const canvas = document.createElement("canvas");
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      container.appendChild(canvas);
      currentCanvas = canvas;
      ctx = canvas.getContext("2d");
      // fill background
      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      drawX = 0;
      lineCount++;
    }

    function drawSpectrogram() {
      if (!audio || audio.paused || audio.ended || isPaused) return;

      analyser.getByteFrequencyData(dataArray);

      // if at end of line, new canvas
      if (drawX >= canvasWidth) createNewCanvas();

      // draw spectrum column
      for (let y = 0; y < analyser.frequencyBinCount; y++) {
        const value = dataArray[y];
        const hue = value * 1.5;
        ctx.fillStyle = `hsl(${hue},100%,50%)`;
        ctx.fillRect(drawX, usableHeight - y, 1, 1);
      }

      const elapsed = audio.currentTime;
      // draw tick region
      if (Math.floor(elapsed) % minorTickSec === 0) {
        // minor tick
        ctx.fillStyle = "white";
        ctx.fillRect(drawX, graphHeight, 1, tickHeight);
      }
      if (Math.floor(elapsed) % majorTickSec === 0) {
        // major tick
        ctx.fillStyle = "white";
        ctx.fillRect(drawX, graphHeight, 2, tickHeight);
      }

      // draw label every labelInterval px
      if (drawX % labelInterval === 0) {
        const label = formatTimeHMS(elapsed);
        const textW = padLabelWidth(label);
        const x0 = drawX - textW/2;
        // label background
        ctx.fillStyle = "black";
        ctx.fillRect(x0, graphHeight + tickHeight, textW, labelHeight);
        // text
        ctx.fillStyle = "white";
        ctx.font = "12px sans-serif";
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";
        ctx.fillText(label, x0 + 4, graphHeight + tickHeight + labelHeight/2);
      }

      // update info
      currentTimeEl.textContent = "Current: " + formatTimeHMS(elapsed);
      statusEl.textContent = "Status: Processing";

      drawX++;
      animationId = requestAnimationFrame(drawSpectrogram);

      // on end
      if (audio.ended) {
        cancelAnimationFrame(animationId);
        statusEl.textContent = "Status: Complete";
        completeControls.style.display = "block";
      }
    }

    startBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) {
        alert("Please select an MP3 file.");
        return;
      }
      // reset
      if (animationId) cancelAnimationFrame(animationId);
      container.innerHTML = "";
      completeControls.style.display = "none";
      pauseBtn.disabled = true;
      isPaused = false;
      drawX = 0;
      lineCount = 0;

      // display file info
      fileInfoEl.textContent = "File: " + file.name;
      statusEl.textContent = "Status: Decoding…";

      // decode to get duration
      const arrayBuffer = await file.arrayBuffer();
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      let audioBuffer;
      try {
        audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
      } catch {
        statusEl.textContent = "Status: Decode error.";
        return;
      }
      totalDuration = audioBuffer.duration;
      durationInfoEl.textContent = "Duration: " + formatTimeHMS(totalDuration);

      // setup audio element
      const blobURL = URL.createObjectURL(file);
      audio = new Audio(blobURL);
      audio.crossOrigin = "anonymous";
      playbackRate = parseFloat(speedSelect.value);
      audio.playbackRate = playbackRate;

      const source = audioCtx.createMediaElementSource(audio);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 512;
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      source.connect(analyser);
      analyser.connect(audioCtx.destination);

      // first canvas
      createNewCanvas();

      pauseBtn.disabled = false;
      statusEl.textContent = "Status: Playing";
      audio.play();
      drawSpectrogram();
    });

    pauseBtn.addEventListener("click", () => {
      if (!audio) return;
      if (!isPaused) {
        isPaused = true;
        audio.pause();
        cancelAnimationFrame(animationId);
        pauseBtn.textContent = "Resume";
        statusEl.textContent = "Status: Paused";
      } else {
        isPaused = false;
        audio.play();
        pauseBtn.textContent = "Pause";
        statusEl.textContent = "Status: Playing";
        drawSpectrogram();
      }
    });

    saveBtn.addEventListener("click", () => {
      const merged = document.createElement("canvas");
      const totalH = lineCount * canvasHeight;
      merged.width = canvasWidth;
      merged.height = totalH;
      const mctx = merged.getContext("2d");
      Array.from(container.children).forEach((c, i) => {
        mctx.drawImage(c, 0, i * canvasHeight);
      });
      const url = merged.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = url;
      a.download = "spectrogram.png";
      a.click();
    });

    back15Btn.addEventListener("click", () => {
      if (audio) audio.currentTime = Math.max(0, audio.currentTime - 15);
    });
    forward15Btn.addEventListener("click", () => {
      if (audio) audio.currentTime = Math.min(totalDuration, audio.currentTime + 15);
    });
    playPauseEndBtn.addEventListener("click", () => {
      pauseBtn.click();
    });
  </script>
</body>
</html>
