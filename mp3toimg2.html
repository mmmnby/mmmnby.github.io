<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Advanced Wrapped Spectrogram</title>
  <style>
    body { background:#111; color:#fff; font-family:sans-serif; text-align:center; margin:0; padding:0; }
    .controls, .info, .status, .navBtnContainer { padding:8px; }
    button, select, input { padding:8px 12px; font-size:16px; margin:4px; }
    .canvas-container { display:flex; flex-direction:column; align-items:center; }
    canvas { background:black; display:block; margin:8px 0; }
    .ticks { height:20px; position:relative; }
    .ticks canvas { position:absolute; top:0; left:0; }
  </style>
</head>
<body>

  <h1>Advanced Wrapped MP3 Spectrogram</h1>

  <div class="info">
    <span id="fileName">File:</span> • Duration: <span id="duration">--</span>
  </div>

  <div class="controls">
    <input type="file" id="audioFile" accept=".mp3" />
    <label>Speed:</label>
    <select id="speed"><option>1×</option><option>2×</option><option>4×</option><option>30×</option><option>60×</option><option>120×</option></select>
    <button id="startBtn">Start</button>
    <button id="pauseBtn" disabled>Pause</button>
  </div>

  <div class="status">Status: waiting for file…</div>

  <div class="canvas-container" id="canvasContainer"></div>

  <div class="navBtnContainer" id="navButtons" style="display:none">
    <button id="rew15">◀ 15 s</button>
    <button id="playPause">▶️</button>
    <button id="fwd15">15 s ▶</button>
  </div>

  <script>
  const fileInput = document.getElementById("audioFile"),
        speedSel = document.getElementById("speed"),
        startBtn = document.getElementById("startBtn"),
        pauseBtn = document.getElementById("pauseBtn"),
        statusEl = document.querySelector(".status"),
        infoFile = document.getElementById("fileName"),
        infoDur = document.getElementById("duration"),
        navBtns = document.getElementById("navButtons"),
        rew15 = document.getElementById("rew15"),
        playPause = document.getElementById("playPause"),
        fwd15 = document.getElementById("fwd15"),
        canvasContainer = document.getElementById("canvasContainer");

  const canvasWidth = window.innerWidth,
        canvasHeight = 300,
        labelInterval = 100,
        labelHeight = 20,
        usableHeight = canvasHeight - labelHeight - 20; // -20 for tick bar

  let audio, audioCtx, analyser, dataArray;
  let currentCanvas, currentCtx, tickCanvas, tickCtx;
  let drawX = 0, isPaused = false, animationId;
  let mp3Duration = 0, playedOnce = false;

  function formatTime(s) {
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=Math.floor(s%60);
    return `${h}h${m}m${ss}s`;
  }

  function makeCanvases() {
    const cv = document.createElement("canvas");
    cv.width = canvasWidth; cv.height = canvasHeight;
    currentCanvas = cv; currentCtx = cv.getContext("2d");
    currentCtx.fillStyle="black"; currentCtx.fillRect(0,0,canvasWidth,canvasHeight);
    // tick canvas
    const tc = document.createElement("canvas");
    tc.width = canvasWidth; tc.height = 20;
    tickCanvas = tc; tickCtx = tc.getContext("2d");
    canvasContainer.appendChild(tc);
    canvasContainer.appendChild(cv);
    drawX=0;
  }

  function drawTicks() {
    tickCtx.clearRect(0,0,canvasWidth,20);
    const secondsPerPx = canvasWidth/mp3Duration;
    const timeAtX = (secondsPerPx * drawX);
    const currentSec = Math.floor(timeAtX);
    const firstSec = currentSec - (drawX * secondsPerPx);
    // not needed dynamic; we just draw minor every minute, major every 15
    for(let x=0;x<canvasWidth;x++){
      const t = x*secondsPerPx;
      if(t%900<secondsPerPx){
        tickCtx.fillStyle="white"; tickCtx.fillRect(x,0,2,20);
      } else if(t%60<secondsPerPx){
        tickCtx.fillStyle="gray"; tickCtx.fillRect(x,10,1,10);
      }
    }
  }

  function drawSpectro(){
    if(!audio||audio.paused||audio.ended||isPaused) return;
    analyser.getByteFrequencyData(dataArray);
    if(drawX>=canvasWidth) makeCanvases();
    for(let y=0;y<analyser.frequencyBinCount;y++){
      const v=dataArray[y], hue=v*1.5;
      currentCtx.fillStyle=`hsl(${hue},100%,50%)`;
      currentCtx.fillRect(drawX,usableHeight-y,1,1);
    }
    if(drawX%labelInterval===0){
      const label=formatTime(audio.currentTime);
      currentCtx.fillStyle="black";
      currentCtx.fillRect(drawX-30,usableHeight+20,60,labelHeight);
      currentCtx.fillStyle="white";
      currentCtx.textAlign="center";
      currentCtx.font="12px sans-serif";
      currentCtx.fillText(label,drawX,usableHeight+35);
    }
    drawTicks();
    drawX++;
    statusEl.textContent = `Status: processing ${formatTime(audio.currentTime)} of ${formatTime(mp3Duration)}`;
    animationId = requestAnimationFrame(drawSpectro);
    playedOnce = true;
  }

  startBtn.onclick=async()=>{
    const file=fileInput.files[0]; if(!file)return alert("Select file");
    audio?.pause(); cancelAnimationFrame(animationId);
    canvasContainer.innerHTML="";
    isPaused=false; pauseBtn.disabled=false; pauseBtn.textContent="Pause"; navBtns.style.display="none";
    infoFile.textContent="File: "+file.name;
    const blob=URL.createObjectURL(file);
    audio=new Audio(blob); audio.crossOrigin="anonymous";
    audio.playbackRate=parseFloat(speedSel.value);
    audioCtx=new (AudioContext||webkitAudioContext)();
    const src=audioCtx.createMediaElementSource(audio);
    analyser=audioCtx.createAnalyser(); analyser.fftSize=512;
    dataArray=new Uint8Array(analyser.frequencyBinCount);
    src.connect(analyser); analyser.connect(audioCtx.destination);
    // load file duration
    audio.onloadedmetadata=()=>{
      mp3Duration=audio.duration;
      infoDur.textContent=formatTime(mp3Duration);
      statusEl.textContent="Status: ready to start";
    };
    makeCanvases();
    audio.play();
    drawSpectro();
  };

  pauseBtn.onclick=()=>{
    if(!audio)return;
    if(!isPaused){
      audio.pause(); isPaused=true; pauseBtn.textContent="Resume"; cancelAnimationFrame(animationId);
    }else{
      audio.play(); isPaused=false; pauseBtn.textContent="Pause"; drawSpectro();
    }
  };

  audio?.onended=()=>{
    statusEl.textContent="Status: complete";
    navBtns.style.display="block"; playPause.textContent="▶️";
  };

  rew15.onclick=()=>audio.currentTime=Math.max(0,audio.currentTime-15);
  fwd15.onclick=()=>audio.currentTime=Math.min(mp3Duration,audio.currentTime+15);
  playPause.onclick=()=>{ if(audio.paused) { audio.play(); playPause.textContent="⏸"; } else { audio.pause(); playPause.textContent="▶️"; } };
  </script>

</body>
</html>
