<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spectrogram with Robust Phase 2 Player</title>
  <style>
    body { background:#111; color:#fff; font-family:sans-serif; margin:0; text-align:center }
    .controls { padding:10px }
    .controls>* { margin:4px; font-size:16px }
    #timeDisplay { margin-top:6px; font-size:14px; font-style:italic }
    .canvas-container { position:relative; display:inline-block; margin-bottom:20px }
    canvas.spectro { background:#000; display:block }
    canvas.overlay { position:absolute; left:0; top:0; pointer-events:auto }
    #navButtons { margin:10px; display:none }
    #navButtons button { margin:0 6px; font-size:16px; padding:6px 12px }
  </style>
</head>
<body>

<h1>Spectrogram + Robust Phase 2 Player</h1>

<div class="controls">
  <input type="file" id="audioFile" accept=".mp3">
  <label>Speed:
    <select id="speed">
      <option>1</option><option>2</option><option>4</option>
      <option>30</option><option>60</option><option>120</option>
    </select>×
  </label>
  <button id="startBtn">Play</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="saveBtn">Download PNG</button>
  <div id="timeDisplay">No file loaded.</div>
</div>

<div id="rowsContainer"></div>

<div id="navButtons">
  <button id="back15">◀ 15s</button>
  <button id="masterToggle">Play/Pause</button>
  <button id="forward15">15s ▶</button>
</div>

<script>
// ==== Constants ====
const canvasWidth = window.innerWidth;
const canvasHeight = 300;
const tickHeight = 10;
const labelHeight = 20;
const usableHeight = canvasHeight - tickHeight - labelHeight;
const labelInterval = 100, labelPadding = 6;

// ==== DOM ====
const fileInput = document.getElementById('audioFile'),
      speedSelect = document.getElementById('speed'),
      startBtn = document.getElementById('startBtn'),
      pauseBtn = document.getElementById('pauseBtn'),
      saveBtn = document.getElementById('saveBtn'),
      timeDisplay = document.getElementById('timeDisplay'),
      rowsContainer = document.getElementById('rowsContainer'),
      navButtons = document.getElementById('navButtons'),
      back15 = document.getElementById('back15'),
      masterToggle = document.getElementById('masterToggle'),
      forward15 = document.getElementById('forward15');

// ==== Phase 1 variables (remains unchanged) ====
let audioCtx, analyser, dataArray;
let drawX = 0, spectrogramComplete = false, animationId;
let spectroCanvases = [], overlayCanvases = [], rowTimestamps = [];

// ==== Phase 2 playback ====
let playerAudio = null,
    cursorTimer = null,
    isPlaying = false;

// ==== Utilities ====
function formatTime(s){
  const h = Math.floor(s/3600),
        m = Math.floor((s%3600)/60),
        sec = Math.floor(s%60);
  return `${h}h${m}m${sec}s`;
}

function updateTimeDisplay(){
  let cur = playerAudio?.currentTime || 0;
  let tot = playerAudio?.duration || 0;
  timeDisplay.textContent = `Current: ${formatTime(cur)} / Total: ${formatTime(tot)}`;
}

// ==== Phase 1 Logic (unchanged) ====
// Your working Phase 1 code should go here:
// e.g. createNewRow(), drawSpectrogram(), rowTimestamps filling, etc.
// ... *omitted* (assume identical to your working version) ...

// ==== PHASE 2 FUNCTIONS ====

function initPhase2Player(fileUrl) {
  if (playerAudio) {
    playerAudio.pause();
    playerAudio = null;
  }
  playerAudio = new Audio(fileUrl);
  playerAudio.crossOrigin = 'anonymous';
  playerAudio.playbackRate = 1; // always 1×
  playerAudio.load();

  playerAudio.addEventListener('loadedmetadata', () => {
    updateTimeDisplay();
  });

  playerAudio.addEventListener('ended', () => {
    isPlaying = false;
    clearInterval(cursorTimer);
    pauseBtn.textContent = 'Play';
  });

  // Start cursor updates
  cursorTimer = setInterval(updateCursor, 100);
}

function updateCursor() {
  if (!spectrogramComplete || !playerAudio || playerAudio.duration === 0) return;
  updateTimeDisplay();

  overlayCanvases.forEach(o => o.ctx.clearRect(0,0,canvasWidth,canvasHeight));

  const t = playerAudio.currentTime;
  const idx = rowTimestamps.findIndex((ts,i) =>
    t >= ts && (rowTimestamps[i+1] === undefined || t < rowTimestamps[i+1])
  );
  if (idx < 0) return;

  const t0 = rowTimestamps[idx],
        t1 = rowTimestamps[idx+1] || playerAudio.duration,
        frac = (t - t0)/(t1 - t0),
        x = Math.round(frac * canvasWidth);

  const ctx = overlayCanvases[idx].ctx;
  ctx.lineWidth = 4;
  ctx.strokeStyle = '#000';
  ctx.beginPath(); ctx.moveTo(x+.5,0); ctx.lineTo(x+.5,canvasHeight); ctx.stroke();

  ctx.lineWidth = 2;
  ctx.strokeStyle = '#fff';
  ctx.beginPath(); ctx.moveTo(x+.5,0); ctx.lineTo(x+.5,canvasHeight); ctx.stroke();

  ctx.lineWidth = 2;
  ctx.strokeStyle = 'red';
  ctx.beginPath(); ctx.moveTo(x+.5,0); ctx.lineTo(x+.5,canvasHeight); ctx.stroke();
}

function togglePlayPause() {
  if (!playerAudio) return;
  if (isPlaying) {
    playerAudio.pause();
    isPlaying = false;
    pauseBtn.textContent = 'Play';
  } else {
    playerAudio.play().catch(() => {
      playerAudio.load();
      playerAudio.play();
    });
    isPlaying = true;
    pauseBtn.textContent = 'Pause';
  }
}

// seek helper
function seek(offset) {
  if (!playerAudio) return;
  let t = (playerAudio.currentTime || 0) + offset;
  t = Math.max(0, Math.min(playerAudio.duration, t));
  playerAudio.currentTime = t;
  if (!isPlaying) togglePlayPause();
}

// ==== BUTTON ACTIONS ====
back15.onclick = ()=> seek(-15);
forward15.onclick = ()=> seek(15);
masterToggle.onclick = ()=> togglePlayPause();

// Save output
saveBtn.onclick = () => {
  const m = spectroCanvases.length;
  const merged = document.createElement('canvas');
  merged.width = canvasWidth;
  merged.height = canvasHeight * m;
  const mctx = merged.getContext('2d');
  spectroCanvases.forEach((o,i) => mctx.drawImage(o.canvas, 0, i*canvasHeight));
  const a = document.createElement('a');
  a.href = merged.toDataURL('image/png');
  a.download = 'spectrogram.png';
  a.click();
};

// ==== START BUTTON (Phase 1 -> Phase 2 trigger) ====
startBtn.onclick = () => {
  const file = fileInput.files[0];
  if (!file) return alert('Select an MP3');
  
  const url = URL.createObjectURL(file);
  
  // Trigger Phase 1 processing
  // Example:
  // startPhase1Processing(url);
  // When Phase 1 finishes, call:
  // initPhase2Player(url); navButtons.style.display = 'block';
  
  // Below is a placeholder to illustrate:
  initPhase2Player(url);
  navButtons.style.display = 'block';
  
  startBtn.disabled = true;
  pauseBtn.disabled = false;
  pauseBtn.textContent = 'Play';  
};

pauseBtn.onclick = () => {
  togglePlayPause();
};
</script>
</body>
</html>
