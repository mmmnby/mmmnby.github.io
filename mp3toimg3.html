<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Primed Spectrogram Player</title>
  <style>
    body { background:#111; color:#fff; font-family:sans-serif; margin:0; text-align:center; }
    .controls { padding:10px; }
    .controls > * { margin:5px; font-size:16px; }
    #currentTime { font-weight:bold; margin-top:4px; }
    .canvas-container { position:relative; display:inline-block; }
    canvas.spectro { background:#000; display:block; }
    canvas.overlay { position:absolute; top:0; left:0; pointer-events:none; }
    #navButtons { margin-top:10px; display:none; }
    #navButtons button { margin:0 10px; padding:6px 12px; font-size:16px; }
  </style>
</head>
<body>

  <h1>Primed Spectrogram Player</h1>
  <div class="controls">
    <input type="file" id="audioFile" accept=".mp3">
    <label>Speed:
      <select id="speed"><option>1</option><option>2</option><option>4</option><option>30</option><option>60</option><option>120</option></select>×
    </label>
    <button id="startBtn">Generate Spectrogram</button>
    <div id="currentTime">00h0m00s</div>
  </div>

  <div class="canvas-container" id="canvasWrapper"></div>

  <div class="controls" id="navButtons">
    <button id="back15">◀ 15s</button>
    <button id="masterToggle">Play</button>
    <button id="forward15">15s ▶</button>
  </div>

  <script>
  const W = window.innerWidth;
  const H = 300, TH = 20, UT = H-TH, LI=100, LP=6;
  const canvasWrapper = document.getElementById('canvasWrapper');
  const audioFile = document.getElementById('audioFile');
  const speedSel = document.getElementById('speed');
  const startBtn = document.getElementById('startBtn');
  const currentTimeDiv = document.getElementById('currentTime');
  const navButtons = document.getElementById('navButtons');
  const back15 = document.getElementById('back15');
  const masterToggle = document.getElementById('masterToggle');
  const forward15 = document.getElementById('forward15');

  let audio, audioCtx, analyser, dataArray;
  let canvases = [], overlay, octx, totalLines, duration=0;
  let drawX=0, ctx, spectrogramDrawn=false;
  let cursorTimer, isPlaying=false;

  function fmt(s) {
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=Math.floor(s%60);
    return `${h}h${m}m${sec}s`;
  }

  function updateTime() {
    const t = audio ? audio.currentTime : 0;
    currentTimeDiv.textContent = fmt(t);
  }

  function createLineCanvas(){
    const c = document.createElement('canvas');
    c.width=W; c.height=H; c.className='spectro';
    ctx = c.getContext('2d');
    ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
    canvasWrapper.appendChild(c);
    canvases.push(c);
    drawX=0;
  }

  function createOverlay(){
    overlay = document.createElement('canvas');
    overlay.width = W; overlay.height = H;
    overlay.className='overlay';
    canvasWrapper.appendChild(overlay);
    octx = overlay.getContext('2d');
  }

  function drawSpectrogram(callbackWhenDone){
    let buffer, step, bins;
    analyseLoop();

    function analyseLoop(){
      if (!audioCtx || !analyser) return;
      if (!audio || !audio.duration) return;

      analyser.getByteFrequencyData(dataArray);
      if (drawX>=W){ createLineCanvas(); }
      for (let y=0;y<analyser.frequencyBinCount;y++){
        const v=dataArray[y];
        ctx.fillStyle=`hsl(${v*1.5},100%,50%)`;
        ctx.fillRect(drawX, UT-y,1,1);
      }
      if (drawX%60===0){
        ctx.strokeStyle='#fff';
        ctx.lineWidth = (Math.floor((drawX+canvases.length*W)/W)*1)%15===0 ? 2:1;
        ctx.beginPath(); ctx.moveTo(drawX+.5,UT); ctx.lineTo(drawX+.5,UT+10); ctx.stroke();
      }
      if (drawX%LI===0){
        const t=((canvases.length-1)*W + drawX)/W * duration;
        const label=fmt(t);
        const tw=ctx.measureText(label).width;
        ctx.fillStyle='#000'; ctx.fillRect(drawX-tw/2-LP,UT+10,tw+LP*2,TH);
        ctx.fillStyle='#fff'; ctx.textAlign='center';
        ctx.font='12px sans-serif';
        ctx.fillText(label,drawX,UT+12);
      }
      drawX++;
      if ((drawX + (canvases.length-1)*W) < W*(duration*speedSel.value)*1.1){ 
        requestAnimationFrame(analyseLoop);
      } else {
        spectrogramDrawn=true;
        callbackWhenDone();
      }
    }
  }

  function startCursor(){
    if (!octx)return;
    octx.clearRect(0,0,W,H);
    updateTime();
    if (!audio) return;

    const pos = audio.currentTime/duration * W * canvases.length;
    const line = Math.floor(pos/W), x = pos%W;
    octx.clearRect(0,0,W,H);
    octx.strokeStyle='red'; octx.lineWidth=1;
    octx.beginPath(); octx.moveTo(x+.5,0); octx.lineTo(x+.5,H);octx.stroke();

    cursorTimer = setTimeout(startCursor,200);
  }

  startBtn.onclick = ()=>{
    const file=audioFile.files[0]; if(!file)return alert('Select mp3');
    audio = new Audio(URL.createObjectURL(file));
    audio.crossOrigin='anonymous';
    duration = 0;
    audio.onloadedmetadata = ()=>{
      duration=audio.duration;
      canvases=[]; canvasWrapper.innerHTML=''; spectrogramDrawn=false;
      createLineCanvas(); createOverlay();
      audioCtx=new (AudioContext||webkitAudioContext)();
      const src=audioCtx.createMediaElementSource(audio);
      analyser=audioCtx.createAnalyser(); analyser.fftSize=512;
      dataArray=new Uint8Array(analyser.frequencyBinCount);
      src.connect(analyser); analyser.connect(audioCtx.destination);

      drawSpectrogram(()=>{
        audio.currentTime=0;
        navButtons.style.display='block'; masterToggle.textContent='Play';
        updateTime();
        startBtn.disabled=true;
      });
    };
  };

  masterToggle.onclick = ()=>{
    if (!spectrogramDrawn)return;
    if (!isPlaying){
      audio.play();
      isPlaying=true;
      masterToggle.textContent='Pause';
      startCursor();
    } else {
      audio.pause();
      isPlaying=false;
      masterToggle.textContent='Play';
      clearTimeout(cursorTimer);
    }
  };

  back15.onclick = ()=>{ if (audio) audio.currentTime=Math.max(0,audio.currentTime-15); };
  forward15.onclick = ()=>{ if (audio)audio.currentTime=Math.min(duration,audio.currentTime+15); };
</script>
</body>
</html>
