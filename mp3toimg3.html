<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spectrogram Player</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      text-align: center;
    }
    .controls {
      padding: 10px;
    }
    .controls > * {
      margin: 5px;
      font-size: 16px;
    }
    #info {
      margin-top: 8px;
      font-style: italic;
    }
    .canvas-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .wrapper {
      position: relative;
      margin: 10px 0;
    }
    canvas {
      background: #000;
      display: block;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    #navButtons {
      margin-top: 10px;
      display: none;
    }
    #navButtons button {
      margin: 0 10px;
      font-size: 16px;
      padding: 6px 12px;
    }
  </style>
</head>
<body>

  <h1>Live Spectrogram Viewer</h1>

  <div class="controls">
    <input type="file" id="audioFile" accept=".mp3" />
    <label>Speed:
      <select id="speed">
        <option>1</option><option>2</option><option>4</option>
        <option>30</option><option>60</option><option>120</option>
      </select>×
    </label>
    <button id="startBtn">Start</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="saveBtn">Download PNG</button>
    <div id="info">No file loaded.</div>
  </div>

  <div class="canvas-container" id="canvasContainer"></div>

  <div id="navButtons">
    <button id="back15">◀ 15s</button>
    <button id="masterToggle">Play</button>
    <button id="forward15">15s ▶</button>
  </div>

  <script>
    // Constants
    const canvasWidth = window.innerWidth;
    const canvasHeight = 300;
    const tickHeight = 10;
    const labelHeight = 20;
    const usableHeight = canvasHeight - tickHeight - labelHeight;
    const labelInterval = 100; // px
    const labelPadding = 6; // px

    // UI
    const fileInput = document.getElementById('audioFile');
    const speedSelect = document.getElementById('speed');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const saveBtn = document.getElementById('saveBtn');
    const infoDiv = document.getElementById('info');
    const container = document.getElementById('canvasContainer');
    const navButtons = document.getElementById('navButtons');
    const back15 = document.getElementById('back15');
    const masterToggle = document.getElementById('masterToggle');
    const forward15 = document.getElementById('forward15');

    // State
    let audio, audioCtx, analyser, dataArray;
    let drawX = 0, isPaused = false, animationId;
    let currentCanvas, ctx;
    let spectrogramComplete = false;

    function formatTime(s) {
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = Math.floor(s % 60);
      return `${h}h${m}m${sec}s`;
    }

    function createCanvasLine() {
      const c = document.createElement('canvas');
      c.width = canvasWidth;
      c.height = canvasHeight;
      const cctx = c.getContext('2d');
      cctx.fillStyle = '#000';
      cctx.fillRect(0, 0, canvasWidth, canvasHeight);
      container.appendChild(c);
      drawX = 0;
      currentCanvas = c;
      ctx = cctx;
    }

    function updateInfo() {
      const name = fileInput.files[0]?.name || 'Unknown';
      const dur = formatTime(audio.duration || 0);
      const now = formatTime(audio.currentTime || 0);
      infoDiv.textContent = `File: ${name} | Total: ${dur} | Now: ${now}`;
    }

    function drawSpectrogram() {
      if (!audio || audio.paused || audio.ended || isPaused) return;

      analyser.getByteFrequencyData(dataArray);

      if (drawX >= canvasWidth) {
        createCanvasLine();
      }

      for (let y = 0; y < analyser.frequencyBinCount; y++) {
        const v = dataArray[y];
        ctx.fillStyle = `hsl(${v * 1.5},100%,50%)`;
        ctx.fillRect(drawX, usableHeight - y, 1, 1);
      }

      updateInfo();

      const elapsed = Math.floor(audio.currentTime);
      if (elapsed % 60 === 0) {
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = (elapsed % 900 === 0 ? 2 : 1);
        ctx.beginPath();
        ctx.moveTo(drawX + 0.5, usableHeight);
        ctx.lineTo(drawX + 0.5, usableHeight + tickHeight);
        ctx.stroke();
      }

      if (drawX % labelInterval === 0) {
        const label = formatTime(audio.currentTime);
        const tw = ctx.measureText(label).width;
        ctx.fillStyle = '#000';
        ctx.fillRect(drawX - tw/2 - labelPadding, usableHeight + tickHeight, tw + labelPadding*2, labelHeight);
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.font = '12px sans-serif';
        ctx.fillText(label, drawX, usableHeight + tickHeight + 2);
      }

      drawX++;
      animationId = requestAnimationFrame(drawSpectrogram);
    }

    function enterPhaseTwo() {
      spectrogramComplete = true;
      navButtons.style.display = 'block';

      // Merge all lines into one background canvas
      const lines = container.children;
      const totalHeight = canvasHeight * lines.length;
      const bgCanvas = document.createElement('canvas');
      bgCanvas.width = canvasWidth;
      bgCanvas.height = totalHeight;
      const bgCtx = bgCanvas.getContext('2d');
      for (let i = 0; i < lines.length; i++) {
        bgCtx.drawImage(lines[i], 0, i * canvasHeight);
      }

      // Clear container and wrap background + overlay
      container.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = 'wrapper';
      wrap.style.width = canvasWidth + 'px';
      wrap.style.height = totalHeight + 'px';
      wrap.appendChild(bgCanvas);

      const overlay = document.createElement('canvas');
      overlay.id = 'overlay';
      overlay.width = canvasWidth;
      overlay.height = totalHeight;
      wrap.appendChild(overlay);
      container.appendChild(wrap);

      // Click-to-seek on overlay
      overlay.addEventListener('click', e => {
        const rect = overlay.getBoundingClientRect();
        const yClick = e.clientY - rect.top;
        const xClick = e.clientX - rect.left;
        const line = Math.floor(yClick / canvasHeight);
        const posX = xClick;
        const totalPos = line * canvasWidth + posX;
        const seekTime = (totalPos / (canvasWidth * lines.length)) * audio.duration;
        audio.currentTime = seekTime;
        if (!audio.paused) audio.play();
      });

      // Red line animation
      const octx = overlay.getContext('2d');
      function drawSeekLine() {
        octx.clearRect(0, 0, overlay.width, overlay.height);
        const t = audio.currentTime / audio.duration;
        const totalPixels = canvasWidth * lines.length;
        const px = t * totalPixels;
        const lineNum = Math.floor(px / canvasWidth);
        const x = px % canvasWidth;
        octx.strokeStyle = 'red';
        octx.lineWidth = 2;
        octx.beginPath();
        octx.moveTo(x + .5, lineNum * canvasHeight);
        octx.lineTo(x + .5, lineNum * canvasHeight + canvasHeight);
        octx.stroke();
        requestAnimationFrame(drawSeekLine);
      }
      drawSeekLine();
    }

    startBtn.onclick = () => {
      const file = fileInput.files[0];
      if (!file) return alert('Select an MP3 file.');
      cancelAnimationFrame(animationId);
      container.innerHTML = '';
      navButtons.style.display = 'none';
      spectrogramComplete = false;

      audio = new Audio(URL.createObjectURL(file));
      audio.crossOrigin = 'anonymous';
      audio.playbackRate = +speedSelect.value;
      audio.onended = enterPhaseTwo;

      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const src = audioCtx.createMediaElementSource(audio);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 512;
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      src.connect(analyser);
      analyser.connect(audioCtx.destination);

      pauseBtn.disabled = false;
      startBtn.disabled = true;
      createCanvasLine();
      isPaused = false;

      audio.play();
      drawSpectrogram();
    };

    pauseBtn.onclick = () => {
      if (!audio) return;
      isPaused = !isPaused;
      if (isPaused) {
        audio.pause();
        cancelAnimationFrame(animationId);
        pauseBtn.textContent = 'Resume';
      } else {
        if (!spectrogramComplete) drawSpectrogram();
        else requestAnimationFrame(drawSpectrogram);
        audio.play();
        pauseBtn.textContent = 'Pause';
      }
    };

    back15.onclick = () => { if (audio) audio.currentTime = Math.max(0, audio.currentTime - 15); };
    forward15.onclick = () => { if (audio) audio.currentTime = Math.min(audio.duration, audio.currentTime + 15); };
    masterToggle.onclick = () => {
      if (!audio) return;
      if (audio.paused || audio.currentTime === 0) {
        audio.currentTime = 0;
        audio.play();
        masterToggle.textContent = 'Pause';
      } else {
        audio.pause();
        masterToggle.textContent = 'Play';
      }
    };

    saveBtn.onclick = () => {
      const lines = container.querySelectorAll('.wrapper canvas:first-child');
      if (!lines.length) return;
      const merged = document.createElement('canvas');
      merged.width = canvasWidth;
      merged.height = canvasHeight * lines.length;
      const mctx = merged.getContext('2d');
      lines.forEach((c, i) => mctx.drawImage(c, 0, i * canvasHeight));
      const a = document.createElement('a');
      a.href = merged.toDataURL('image/png');
      a.download = 'spectrogram.png';
      a.click();
    };
  </script>
</body>
</html>
