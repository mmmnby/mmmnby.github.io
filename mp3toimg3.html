<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Advanced Wrapped Spectrogram</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    .controls, .postControls {
      padding: 10px;
    }
    input, select, button {
      padding: 6px 12px;
      margin: 4px;
      font-size: 14px;
    }
    #fileInfo, #masterTime {
      margin: 6px 0;
      font-size: 14px;
    }
    .canvas-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      background: black;
      margin: 8px 0;
      display: block;
    }
    .postControls {
      display: none;
    }
  </style>
</head>
<body>

  <h1>Wrapped Spectrogram Viewer</h1>

  <div class="controls">
    <input type="file" id="audioFile" accept=".mp3" />
    <label for="speed">Speed:</label>
    <select id="speed">
      <option value="1">1×</option>
      <option value="2">2×</option>
      <option value="4">4×</option>
      <option value="30">30×</option>
      <option value="60">60×</option>
      <option value="120">120×</option>
    </select>
    <button id="startBtn">Start</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="saveBtn">Download PNG</button>
  </div>

  <div id="fileInfo">No file loaded.</div>
  <div id="masterTime">Current: 0h0m0s</div>

  <div class="canvas-container" id="canvasContainer"></div>

  <!-- Inline FFT.js omitted (we use AnalyserNode) -->
  <script>
    // UI elements
    const fileInput = document.getElementById('audioFile');
    const speedSelect = document.getElementById('speed');
    const startBtn   = document.getElementById('startBtn');
    const pauseBtn   = document.getElementById('pauseBtn');
    const saveBtn    = document.getElementById('saveBtn');
    const fileInfo   = document.getElementById('fileInfo');
    const masterTime = document.getElementById('masterTime');
    const canvasContainer = document.getElementById('canvasContainer');

    // Canvas settings
    const canvasWidth  = window.innerWidth;
    const canvasHeight = 300;
    const labelHeight  = 20;
    const usableHeight = canvasHeight - labelHeight;
    const labelInterval= 100; // px

    // State
    let audio, audioCtx, analyser, dataArray;
    let playbackRate = 1;
    let drawX = 0;
    let currentCanvas, ctx;
    let isPaused = false, animationId;

    // Format seconds to HhMmSs (no leading zeros)
    function formatTime(sec) {
      const s = Math.floor(sec);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const ss= s % 60;
      return h+'h'+m+'m'+ss+'s';
    }

    // Create and append a fresh canvas row
    function newCanvasRow() {
      const c = document.createElement('canvas');
      c.width  = canvasWidth;
      c.height = canvasHeight;
      c.style.border = '1px solid #444';
      const cctx = c.getContext('2d');
      cctx.fillStyle = 'black';
      cctx.fillRect(0, 0, canvasWidth, canvasHeight);
      canvasContainer.appendChild(c);
      currentCanvas = c;
      ctx = cctx;
      drawX = 0;
    }

    // Draw one frame of spectrogram
    function drawFrame() {
      if (!audio || audio.paused || audio.ended || isPaused) return;

      analyser.getByteFrequencyData(dataArray);

      // If at end of row, start a new one
      if (drawX >= canvasWidth) newCanvasRow();

      // Draw frequencies
      for (let y = 0; y < analyser.frequencyBinCount; y++) {
        const v = dataArray[y];
        ctx.fillStyle = `hsl(${v*1.5},100%,50%)`;
        ctx.fillRect(drawX, usableHeight - y, 1, 1);
      }

      // Compute elapsed master time
      const elapsed = audio.currentTime;
      masterTime.textContent = 'Current: ' + formatTime(elapsed);

      // Ticks and labels every labelInterval px
      if (drawX % labelInterval === 0) {
        // Position
        const x = drawX;
        // Tick height: thin for each minute, thick for 15-min multiples
        const sec = Math.floor(elapsed);
        if (sec % 60 === 0) {
          const isQuarter = (sec % 900 === 0);
          const tickH = isQuarter ? 12 : 6;
          const y0 = usableHeight - analyser.frequencyBinCount - tickH;
          const y1 = usableHeight + tickH;
          ctx.strokeStyle = isQuarter ? '#fff' : '#888';
          ctx.lineWidth = isQuarter ? 2 : 1;
          ctx.beginPath();
          ctx.moveTo(x+0.5, usableHeight);
          ctx.lineTo(x+0.5, usableHeight + tickH);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x+0.5, usableHeight);
          ctx.lineTo(x+0.5, usableHeight - tickH);
          ctx.stroke();
        }
        // Label background (padding)
        ctx.fillStyle = 'black';
        ctx.fillRect(x - 30, usableHeight, 60, labelHeight);
        // Draw time label
        ctx.fillStyle = 'white';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(formatTime(elapsed), x, usableHeight + 14);
      }

      drawX++;
      animationId = requestAnimationFrame(drawFrame);
    }

    // Start processing
    startBtn.onclick = () => {
      const file = fileInput.files[0];
      if (!file) return alert('Select an MP3 file first.');
      // Reset
      window.cancelAnimationFrame(animationId);
      canvasContainer.innerHTML = '';
      drawX = 0;
      // Display file info
      const sizeKB = Math.round(file.size/1024);
      fileInfo.textContent = `Loaded: ${file.name} — ${sizeKB} KB — decoding...`;
      // Setup audio
      const url = URL.createObjectURL(file);
      audio = new Audio(url);
      playbackRate = parseFloat(speedSelect.value);
      audio.playbackRate = playbackRate;
      pauseBtn.disabled = false;
      pauseBtn.textContent = 'Pause';
      // AudioContext + analyser
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const src = audioCtx.createMediaElementSource(audio);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 512;
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      src.connect(analyser);
      analyser.connect(audioCtx.destination);
      // When metadata loaded, show duration
      audio.onloadedmetadata = () => {
        fileInfo.textContent = 
          `Loaded: ${file.name} — ${sizeKB} KB — Duration: ${formatTime(audio.duration)}`;
      };
      // When ended, show post controls
      audio.onended = () => {
        showPostControls();
      };
      // First canvas row
      newCanvasRow();
      isPaused = false;
      audio.play();
      drawFrame();
    };

    // Pause / Resume
    pauseBtn.onclick = () => {
      if (!audio) return;
      isPaused = !isPaused;
      if (isPaused) {
        audio.pause();
        cancelAnimationFrame(animationId);
        pauseBtn.textContent = 'Resume';
      } else {
        audio.play();
        drawFrame();
        pauseBtn.textContent = 'Pause';
      }
    };

    // Download PNG of full stacked canvases
    saveBtn.onclick = () => {
      const rows = Array.from(canvasContainer.children);
      const fullH = rows.length * canvasHeight;
      const big = document.createElement('canvas');
      big.width = canvasWidth;
      big.height= fullH;
      const bctx = big.getContext('2d');
      rows.forEach((c,i)=> bctx.drawImage(c,0,i*canvasHeight));
      const link = document.createElement('a');
      link.href = big.toDataURL('image/png');
      link.download = 'spectrogram.png';
      link.click();
    };

    // Post-processing controls: ←15s, Play/Pause, 15s→
    function showPostControls() {
      if (document.getElementById('postCtrls')) return;
      const div = document.createElement('div');
      div.id = 'postCtrls';
      div.className = 'postControls';
      div.style.display = 'block';
      // left
      const left = document.createElement('button');
      left.textContent = '⟵15s';
      left.onclick = () => {
        audio.currentTime = Math.max(0, audio.currentTime - 15);
      };
      // play/pause
      const pp = document.createElement('button');
      pp.textContent = audio.paused ? 'Play' : 'Pause';
      pp.onclick = () => {
        if (audio.paused) {
          audio.play(); pp.textContent='Pause';
        } else {
          audio.pause(); pp.textContent='Play';
        }
      };
      // right
      const right = document.createElement('button');
      right.textContent = '15s⟶';
      right.onclick = () => {
        audio.currentTime = Math.min(audio.duration, audio.currentTime + 15);
      };
      div.append(left, pp, right);
      document.body.insertBefore(div, canvasContainer.nextSibling);
    }
  </script>
</body>
</html>
