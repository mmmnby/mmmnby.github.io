<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spectrogram Player with Precise Overlay</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    .controls {
      padding: 10px;
    }
    .controls > * {
      margin: 4px;
      font-size: 16px;
    }
    #timeDisplay {
      margin-top: 6px;
      font-size: 14px;
      font-style: italic;
    }
    .canvas-container {
      position: relative;
      display: inline-block;
      margin-bottom: 20px;
    }
    canvas.spectro {
      background: #000;
      display: block;
    }
    canvas.overlay {
      position: absolute;
      left: 0;
      top: 0;
      pointer-events: auto;
    }
    #navButtons {
      margin: 10px;
      display: none;
    }
    #navButtons button {
      margin: 0 6px;
      font-size: 16px;
      padding: 6px 12px;
    }
  </style>
</head>
<body>

  <h1>Spectrogram Player with Precise Overlay</h1>
  <div class="controls">
    <input type="file" id="audioFile" accept=".mp3">
    <label>Speed:
      <select id="speed">
        <option>1</option><option>2</option><option>4</option>
        <option>30</option><option>60</option><option>120</option>
      </select>×
    </label>
    <button id="startBtn">Play</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="saveBtn">Download PNG</button>
    <div id="timeDisplay">No file loaded.</div>
  </div>

  <div id="rowsContainer"></div>
  <div id="navButtons">
    <button id="back15">◀ 15s</button>
    <button id="masterToggle">Play/Pause</button>
    <button id="forward15">15s ▶</button>
  </div>

<script>
  const canvasWidth = window.innerWidth;
  const canvasHeight = 300;
  const tickHeight = 10;
  const labelHeight = 20;
  const usableHeight = canvasHeight - tickHeight - labelHeight;
  const labelInterval = 100;
  const labelPadding = 6;

  const fileInput = document.getElementById('audioFile');
  const speedSelect = document.getElementById('speed');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const saveBtn = document.getElementById('saveBtn');
  const timeDisplay = document.getElementById('timeDisplay');
  const rowsContainer = document.getElementById('rowsContainer');
  const navButtons = document.getElementById('navButtons');
  const back15 = document.getElementById('back15');
  const masterToggle = document.getElementById('masterToggle');
  const forward15 = document.getElementById('forward15');

  let audio, audioCtx, analyser, dataArray;
  let drawX = 0, spectrogramComplete = false, isPaused = false, animationId;
  const spectroCanvases = [];
  const overlayCanvases = [];
  const rowCount = () => spectroCanvases.length;

  function formatTime(s) {
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = Math.floor(s%60);
    return `${h}h${m}m${sec}s`;
  }

  function updateTimeDisplay() {
    if (!audio) return;
    timeDisplay.textContent = `Current: ${formatTime(audio.currentTime)}`;
  }

  function createNewRow() {
    const rowDiv = document.createElement('div');
    rowDiv.className = 'canvas-container';
    const sc = document.createElement('canvas');
    sc.width = canvasWidth; sc.height = canvasHeight;
    sc.className = 'spectro';
    const sctx = sc.getContext('2d');
    sctx.fillStyle = '#000'; sctx.fillRect(0,0,canvasWidth,canvasHeight);
    rowDiv.appendChild(sc);
    spectroCanvases.push({canvas: sc, ctx: sctx});
    
    const ov = document.createElement('canvas');
    ov.width = canvasWidth; ov.height = canvasHeight;
    ov.className = 'overlay';
    const ovctx = ov.getContext('2d');
    rowDiv.appendChild(ov);
    overlayCanvases.push({canvas: ov, ctx: ovctx});

    ov.addEventListener('click', (e) => {
      if (!spectrogramComplete) return;
      const rect = ov.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const lineIndex = overlayCanvases.indexOf(overlayCanvases.find(o=>o.canvas===ov));
      const absX = lineIndex * canvasWidth + x;
      const t = absX / (canvasWidth * rowCount()) * audio.duration;
      audio.currentTime = t;
      if (!audio.paused) audio.play();
    });

    rowsContainer.appendChild(rowDiv);
    drawX = 0;
  }

  function drawSpectrogram() {
    if (!audio || audio.paused || audio.ended || isPaused) return;
    analyser.getByteFrequencyData(dataArray);

    if (drawX >= canvasWidth) createNewRow();

    const {ctx} = spectroCanvases[rowCount()-1];
    for (let y=0; y<analyser.frequencyBinCount; y++) {
      const v=dataArray[y];
      ctx.fillStyle = `hsl(${v*1.5},100%,50%)`;
      ctx.fillRect(drawX, usableHeight-y, 1, 1);
    }

    const elapsed = Math.floor(audio.currentTime);
    if (elapsed % 60 === 0) {
      ctx.strokeStyle='#fff';
      ctx.lineWidth = (elapsed%900===0 ?2:1);
      ctx.beginPath();
      ctx.moveTo(drawX+.5, usableHeight);
      ctx.lineTo(drawX+.5, usableHeight+tickHeight);
      ctx.stroke();
    }
    if (drawX%labelInterval===0) {
      const label=formatTime(audio.currentTime);
      const tw=ctx.measureText(label).width;
      ctx.fillStyle='#000';
      ctx.fillRect(drawX-tw/2-labelPadding,usableHeight+tickHeight,tw+2*labelPadding,labelHeight);
      ctx.fillStyle='#fff';
      ctx.textAlign='center'; ctx.textBaseline='top';
      ctx.font='12px sans-serif';
      ctx.fillText(label, drawX, usableHeight+tickHeight+2);
    }

    drawX++;
    updateTimeDisplay();
    animationId=requestAnimationFrame(drawSpectrogram);

    if (audio.ended || audio.currentTime>=audio.duration) {
      spectrogramComplete=true;
      navButtons.style.display='block';
      audio.currentTime=0;
      audio.playbackRate=1;
      drawSeekOverlay();
    }
  }

  function clearOverlay() {
    overlayCanvases.forEach(o=>o.ctx.clearRect(0,0,canvasWidth,canvasHeight));
  }

  function drawSeekOverlay() {
    if (!spectrogramComplete || !audio) return;
    clearOverlay();
    const total = audio.duration;
    const pos = (audio.currentTime/total)*canvasWidth*rowCount();
    const lineIdx = Math.floor(pos/canvasWidth);
    const x = Math.round(pos%canvasWidth);
    const {ctx} = overlayCanvases[lineIdx];
    ctx.strokeStyle='red';
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(x+.5,0); ctx.lineTo(x+.5,canvasHeight);
    ctx.stroke();

    updateTimeDisplay();
    setTimeout(drawSeekOverlay,200);
  }

  startBtn.onclick = () => {
    const file = fileInput.files[0];
    if (!file) return alert('Select an MP3 file.');
    cancelAnimationFrame(animationId);
    rowsContainer.innerHTML=''; spectrogramComplete=false;
    navButtons.style.display='none';

    audio = new Audio(URL.createObjectURL(file));
    audio.crossOrigin='anonymous';
    audio.playbackRate=+speedSelect.value;
    audio.onended = () => {
      spectrogramComplete=true;
      navButtons.style.display='block';
      audio.currentTime=0;
      drawSeekOverlay();
    };

    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const src=audioCtx.createMediaElementSource(audio);
    analyser=audioCtx.createAnalyser(); analyser.fftSize=512;
    dataArray=new Uint8Array(analyser.frequencyBinCount);
    src.connect(analyser); analyser.connect(audioCtx.destination);

    createNewRow();
    isPaused=false; pauseBtn.disabled=false; startBtn.disabled=true;
    audio.play();
    drawSpectrogram();
  };

  pauseBtn.onclick = () => {
    if (!audio) return;
    isPaused = !isPaused;
    if (isPaused) {
      audio.pause();
      cancelAnimationFrame(animationId);
      pauseBtn.textContent='Resume';
    } else {
      audio.play();
      if (!spectrogramComplete) drawSpectrogram();
      else drawSeekOverlay();
      pauseBtn.textContent='Pause';
    }
  };

  back15.onclick = () => { if (audio) audio.currentTime=Math.max(0,audio.currentTime-15); };
  forward15.onclick = () => { if (audio) audio.currentTime=Math.min(audio.duration,audio.currentTime+15); };
  masterToggle.onclick = () => pauseBtn.click();

  saveBtn.onclick = () => {
    const totalRows=rowCount();
    const merged=document.createElement('canvas');
    merged.width=canvasWidth; merged.height=canvasHeight*totalRows;
    const mctx=merged.getContext('2d');
    spectroCanvases.forEach((o,i)=>mctx.drawImage(o.canvas,0,i*canvasHeight));
    const a=document.createElement('a');
    a.href=merged.toDataURL('image/png');
    a.download='spectrogram.png';
    a.click();
  };
</script>
</body>
</html>
