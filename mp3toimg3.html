<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spectrogram Player – Robust Phase 2</title>
  <style>
    body { background:#111; color:#fff; font-family:sans-serif; margin:0; text-align:center; }
    .controls { padding:10px; }
    .controls>* { margin:4px; font-size:16px; }
    #timeDisplay { margin-top:6px; font-size:14px; font-style:italic; }
    .canvas-container { position:relative; display:inline-block; margin-bottom:20px; }
    canvas.spectro { background:#000; display:block; }
    canvas.overlay { position:absolute; left:0; top:0; pointer-events:auto; }
    #navButtons { margin:10px; display:none; }
    #navButtons button { margin:0 6px; font-size:16px; padding:6px 12px; }
  </style>
</head>
<body>

<h1>Spectrogram Player – Robust Phase 2</h1>

<div class="controls">
  <input type="file" id="audioFile" accept=".mp3">
  <label>Speed:
    <select id="speed">
      <option>1</option><option>2</option><option>4</option>
      <option>30</option><option>60</option><option>120</option>
    </select>×
  </label>
  <button id="startBtn">Play</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="saveBtn">Download PNG</button>
  <div id="timeDisplay">No file loaded.</div>
</div>

<div id="rowsContainer"></div>

<div id="navButtons">
  <button id="back15">◀ 15s</button>
  <button id="masterToggle">Play/Pause</button>
  <button id="forward15">15s ▶</button>
</div>

<script>
  const canvasWidth = window.innerWidth;
  const canvasHeight = 300;
  const tickHeight = 10;
  const labelHeight = 20;
  const usableHeight = canvasHeight - tickHeight - labelHeight;
  const labelInterval = 100, labelPadding=6;
  const cursorUpdateMs = 100;

  const fileInput = document.getElementById('audioFile');
  const speedSelect = document.getElementById('speed');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const saveBtn = document.getElementById('saveBtn');
  const timeDisplay = document.getElementById('timeDisplay');
  const rowsContainer = document.getElementById('rowsContainer');
  const navButtons = document.getElementById('navButtons');
  const back15 = document.getElementById('back15');
  const masterToggle = document.getElementById('masterToggle');
  const forward15 = document.getElementById('forward15');

  let audio, audioCtx, analyser, dataArray;
  let drawX=0, spectrogramComplete=false, isPaused=false, animationId, cursorTimer;
  const spectroCanvases = [], overlayCanvases = [], rowTimestamps=[];

  function formatTime(s){
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=Math.floor(s%60);
    return `${h}h${m}m${sec}s`;
  }

  function updateTimeDisplay(){
    if(!audio)return;
    const cur = formatTime(audio.currentTime);
    const tot = isNaN(audio.duration)?'??':formatTime(audio.duration);
    timeDisplay.textContent = `Current: ${cur} / Total: ${tot}`;
  }

  function createNewRow(){
    const rowDiv = document.createElement('div');
    rowDiv.className='canvas-container';

    const sc = document.createElement('canvas');
    sc.width=canvasWidth; sc.height=canvasHeight; sc.className='spectro';
    const sctx = sc.getContext('2d');
    sctx.fillStyle='#000'; sctx.fillRect(0,0,canvasWidth,canvasHeight);
    rowDiv.appendChild(sc);
    spectroCanvases.push({canvas:sc, ctx:sctx});

    const ov = document.createElement('canvas');
    ov.width=canvasWidth; ov.height=canvasHeight; ov.className='overlay';
    const ovctx = ov.getContext('2d');
    rowDiv.appendChild(ov);
    overlayCanvases.push({canvas:ov, ctx:ovctx});

    rowTimestamps.push(audio.currentTime);

    ov.addEventListener('click', e => {
      if(!spectrogramComplete) return;
      const rect = ov.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const idx = overlayCanvases.findIndex(o=>o.canvas===ov);
      const t0 = rowTimestamps[idx];
      const t1 = rowTimestamps[idx+1] || audio.duration;
      const t = t0 + (x/canvasWidth)*(t1 - t0);
      audio.currentTime = t;
      if(audio.paused) audio.play();
    });

    rowsContainer.appendChild(rowDiv);
    drawX = 0;
  }

  function drawSpectrogram(){
    if(!audio || audio.paused || audio.ended || isPaused) return;
    analyser.getByteFrequencyData(dataArray);

    if(drawX>=canvasWidth) createNewRow();
    const {ctx} = spectroCanvases[spectroCanvases.length-1];

    const dataLen = analyser.frequencyBinCount;
    for(let y=0; y<dataLen; y++){
      const v=dataArray[y];
      ctx.fillStyle=`hsl(${v*1.5},100%,50%)`;
      ctx.fillRect(drawX, usableHeight - y, 1, 1);
    }

    const elapsed = Math.floor(audio.currentTime);
    if(elapsed%60===0){
      ctx.strokeStyle='#fff'; ctx.lineWidth=(elapsed%900===0?2:1);
      ctx.beginPath(); ctx.moveTo(drawX+0.5, usableHeight);
      ctx.lineTo(drawX+0.5, usableHeight+tickHeight); ctx.stroke();
    }

    if(drawX%labelInterval===0){
      const lbl=formatTime(audio.currentTime);
      const tw = ctx.measureText(lbl).width;
      ctx.fillStyle='#000';
      ctx.fillRect(drawX - tw/2 - labelPadding, usableHeight+tickHeight, tw+2*labelPadding, labelHeight);
      ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='top';
      ctx.font='12px sans-serif';
      ctx.fillText(lbl, drawX, usableHeight+tickHeight+2);
    }

    drawX++;
    updateTimeDisplay();
    animationId = requestAnimationFrame(drawSpectrogram);

    if(audio.ended || audio.currentTime>=audio.duration){
      spectrogramComplete = true;
      navButtons.style.display='block';
      audio.currentTime = 0;
      drawSeekOverlay();
      startCursorTimer();
    }
  }

  function clearOverlay(){
    overlayCanvases.forEach(o => o.ctx.clearRect(0,0,canvasWidth,canvasHeight));
  }

  function drawSeekOverlay(){
    if(!spectrogramComplete || !audio) return;
    clearOverlay();

    const t = audio.currentTime;
    const idx = rowTimestamps.findIndex((ts,i)=> t>=ts && (rowTimestamps[i+1]===undefined || t<rowTimestamps[i+1]));
    if(idx<0) return;

    const t0=rowTimestamps[idx];
    const t1=rowTimestamps[idx+1]||audio.duration;
    const x = Math.round(((t - t0)/(t1 - t0))*canvasWidth);

    const {ctx} = overlayCanvases[idx];
    const w=4; const halfW=w/2;
    ctx.strokeStyle='black'; ctx.lineWidth=w;
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvasHeight); ctx.stroke();

    ctx.strokeStyle='white'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvasHeight); ctx.stroke();

    ctx.strokeStyle='red'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvasHeight); ctx.stroke();

    updateTimeDisplay();
  }

  function startCursorTimer(){
    clearInterval(cursorTimer);
    cursorTimer = setInterval(drawSeekOverlay, cursorUpdateMs);
  }

  function ensureAudioOK(){
    if(!audio.src){
      audio.src = URL.createObjectURL(fileInput.files[0]);
      audio.crossOrigin = 'anonymous';
      audio.load();
    }
  }

  startBtn.onclick = ()=>{
    const file = fileInput.files[0];
    if(!file) return alert('Select an MP3 file.');

    cancelAnimationFrame(animationId);
    clearInterval(cursorTimer);
    spectrogramComplete=false;
    rowTimestamps.length=0; spectroCanvases.length=0; overlayCanvases.length=0;
    rowsContainer.innerHTML=''; navButtons.style.display='none';
    startBtn.disabled=true; pauseBtn.disabled=false; pauseBtn.textContent='Pause';

    audio = new Audio();
    audio.src = URL.createObjectURL(file);
    audio.crossOrigin='anonymous';
    audio.playbackRate = 1;
    audio.preload='auto';

    audio.addEventListener('loadedmetadata', updateTimeDisplay);
    audio.onended = ()=>{
      spectrogramComplete=true;
      navButtons.style.display='block';
      audio.currentTime=0;
      drawSeekOverlay();
      startCursorTimer();
    }

    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const src = ctx.createMediaElementSource(audio);
    analyser = ctx.createAnalyser(); analyser.fftSize=512;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    src.connect(analyser); analyser.connect(ctx.destination);

    createNewRow();
    audio.play();
    drawSpectrogram();
  };

  pauseBtn.onclick = ()=>{
    if(!audio) return;
    ensureAudioOK();
    isPaused = !isPaused;
    if(isPaused){
      audio.pause();
      cancelAnimationFrame(animationId);
      clearInterval(cursorTimer);
      pauseBtn.textContent='Resume';
    } else {
      audio.playbackRate=1;
      audio.play();
      if(!spectrogramComplete) drawSpectrogram();
      else {
        drawSeekOverlay();
        startCursorTimer();
      }
      pauseBtn.textContent='Pause';
    }
  };

  back15.onclick = ()=>{
    ensureAudioOK();
    if(audio) audio.currentTime=Math.max(0,audio.currentTime-15);
  };
  forward15.onclick = ()=>{
    ensureAudioOK();
    if(audio) audio.currentTime=Math.min(audio.duration,audio.currentTime+15);
  };
  masterToggle.onclick = ()=> pauseBtn.click();

  saveBtn.onclick = ()=>{
    const m = spectroCanvases.length;
    const merged = document.createElement('canvas');
    merged.width = canvasWidth;
    merged.height = canvasHeight * m;
    const mctx = merged.getContext('2d');
    spectroCanvases.forEach((o,i)=>mctx.drawImage(o.canvas, 0, i*canvasHeight));
    const a=document.createElement('a');
    a.href=merged.toDataURL('image/png');
    a.download='spectrogram.png';
    a.click();
  };
</script>

</body>
</html>
