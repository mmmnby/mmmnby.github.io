<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MP3 Spectrogram (Wrapped)</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: sans-serif;
      text-align: center;
    }

    .controls, .status, .nav-buttons {
      padding: 12px;
    }

    button, select, input {
      font-size: 16px;
      margin: 6px;
      padding: 8px 12px;
    }

    .canvas-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    canvas {
      background: black;
      margin: 10px 0;
      display: block;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <h1>MP3 Spectrogram Viewer</h1>

  <div class="controls">
    <input type="file" id="audioFile" accept=".mp3" />
    <label for="speed">Speed:</label>
    <select id="speed">
      <option value="1">1×</option>
      <option value="2">2×</option>
      <option value="4">4×</option>
      <option value="30">30×</option>
      <option value="60">60×</option>
      <option value="120">120×</option>
    </select>
    <button id="startBtn">Start</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="saveBtn">Download</button>
  </div>

  <div class="status">
    <div id="fileInfo">No file loaded</div>
    <div id="progress">Progress: 0s</div>
  </div>

  <div class="canvas-container" id="canvasContainer"></div>

  <div class="nav-buttons hidden" id="navButtons">
    <button id="back15">← 15s</button>
    <button id="playPause">Pause</button>
    <button id="forward15">15s →</button>
  </div>

  <script>
    const fileInput = document.getElementById("audioFile");
    const speedSelect = document.getElementById("speed");
    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const saveBtn = document.getElementById("saveBtn");
    const container = document.getElementById("canvasContainer");
    const fileInfo = document.getElementById("fileInfo");
    const progressDisplay = document.getElementById("progress");
    const navButtons = document.getElementById("navButtons");
    const back15Btn = document.getElementById("back15");
    const playPauseBtn = document.getElementById("playPause");
    const forward15Btn = document.getElementById("forward15");

    const canvasWidth = window.innerWidth;
    const canvasHeight = 300;
    const tickTrackHeight = 20;
    const labelHeight = 20;
    const usableHeight = canvasHeight - tickTrackHeight - labelHeight;

    let audio, audioCtx, analyser, dataArray;
    let currentCanvas, ctx;
    let drawX = 0;
    let isPaused = false;
    let animationId = null;
    let playbackRate = 1;
    let duration = 0;
    let drawTime = 0;

    function formatTime(sec) {
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = Math.floor(sec % 60);
      return `${h}h${m}m${s}s`;
    }

    function createCanvas() {
      const canvas = document.createElement("canvas");
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      container.appendChild(canvas);
      currentCanvas = canvas;
      ctx = canvas.getContext("2d");
      drawX = 0;
    }

    function drawTicks(x, seconds) {
      ctx.fillStyle = "white";
      const mod60 = seconds % 60;
      const mod15min = seconds % 900;

      const width = (mod15min === 0) ? 2 : 1;

      ctx.fillRect(x, usableHeight, width, tickTrackHeight);
    }

    function drawTimeLabel(x, timeStr) {
      ctx.fillStyle = "black";
      ctx.fillRect(x - 25, usableHeight + tickTrackHeight, 50, labelHeight);

      ctx.fillStyle = "white";
      ctx.textAlign = "center";
      ctx.font = "12px sans-serif";
      ctx.fillText(timeStr, x, usableHeight + tickTrackHeight + 14);
    }

    function drawSpectrogram() {
      if (!audio || audio.ended || isPaused) return;

      drawTime = audio.currentTime;

      analyser.getByteFrequencyData(dataArray);
      for (let y = 0; y < analyser.frequencyBinCount; y++) {
        const value = dataArray[y];
        const hue = value * 1.5;
        ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
        ctx.fillRect(drawX, usableHeight - y, 1, 1);
      }

      const seconds = Math.floor(drawTime);

      if (drawX % 1 === 0) {
        drawTicks(drawX, seconds);
      }

      if (drawX % 100 === 0) {
        drawTimeLabel(drawX, formatTime(drawTime));
      }

      progressDisplay.textContent = `Progress: ${formatTime(drawTime)}`;

      drawX++;

      if (drawX >= canvasWidth) {
        createCanvas();
      }

      if (drawTime >= duration) {
        cancelAnimationFrame(animationId);
        navButtons.classList.remove("hidden");
        return;
      }

      animationId = requestAnimationFrame(drawSpectrogram);
    }

    startBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) {
        alert("Please choose a file");
        return;
      }

      container.innerHTML = "";
      navButtons.classList.add("hidden");
      pauseBtn.disabled = false;

      const blobURL = URL.createObjectURL(file);
      audio = new Audio(blobURL);
      audio.crossOrigin = "anonymous";
      audio.preload = "auto";

      const arrayBuffer = await file.arrayBuffer();
      const offlineCtx = new OfflineAudioContext(1, 44100 * 40, 44100);
      const decoded = await offlineCtx.decodeAudioData(arrayBuffer);
      duration = decoded.duration;

      fileInfo.textContent = `Loaded: ${file.name} (${formatTime(duration)})`;

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioCtx.createMediaElementSource(audio);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 512;
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      source.connect(analyser);
      analyser.connect(audioCtx.destination);

      playbackRate = parseFloat(speedSelect.value);
      audio.playbackRate = playbackRate;

      createCanvas();
      isPaused = false;
      audio.play();
      drawSpectrogram();
    });

    pauseBtn.addEventListener("click", () => {
      if (!audio) return;
      isPaused = !isPaused;
      pauseBtn.textContent = isPaused ? "Resume" : "Pause";

      if (isPaused) {
        audio.pause();
        cancelAnimationFrame(animationId);
      } else {
        audio.play();
        drawSpectrogram();
      }
    });

    saveBtn.addEventListener("click", () => {
      const mergedCanvas = document.createElement("canvas");
      const totalHeight = container.childNodes.length * canvasHeight;

      mergedCanvas.width = canvasWidth;
      mergedCanvas.height = totalHeight;
      const mergedCtx = mergedCanvas.getContext("2d");

      container.childNodes.forEach((canvas, i) => {
        mergedCtx.drawImage(canvas, 0, i * canvasHeight);
      });

      const url = mergedCanvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = url;
      a.download = "spectrogram.png";
      a.click();
    });

    back15Btn.addEventListener("click", () => {
      if (!audio) return;
      audio.currentTime = Math.max(0, audio.currentTime - 15);
    });

    forward15Btn.addEventListener("click", () => {
      if (!audio) return;
      audio.currentTime = Math.min(duration, audio.currentTime + 15);
    });

    playPauseBtn.addEventListener("click", () => {
      if (!audio) return;
      isPaused = !isPaused;
      playPauseBtn.textContent = isPaused ? "Resume" : "Pause";

      if (isPaused) {
        audio.pause();
        cancelAnimationFrame(animationId);
      } else {
        audio.play();
        drawSpectrogram();
      }
    });
  </script>
</body>
</html>
